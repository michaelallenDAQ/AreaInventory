---
title: "AreaInventory"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = 'U:/PLAN/michaelallen/main_workbook')
knitr::opts_knit$set(root.dir = 'M:/My Drive/U_drive/main_workbook')
```


```{r run this always}
library(readxl)
library(tidyverse)
library(tidyr)
#turn off scientific notation. Scientific notation is bad when listing SCCs, as often the end
#digits get cut off
options(scipen = 999)

setwd('M:/My Drive/U_drive/main_workbook')
#setwd('U:/PLAN/michaelallen/main_workbook')
#step 1
source('basecodes.R')
start_year <- 2017
end_year <- 2017
#step 2
source('baseTables.R')
#we will fill in this final table with our data
final_table <- vector()

```
This is going to produce a fresh inventory for Utah's Area Source.
This code has 5 main sections:
  1) Base Codes
  Always run this section. 'source('basecodes.R')'. This pull functions you will use later in the script. This section should not pull any variables. It should only generate functions.
  
  2) Base tables
  'source('baseTables.R')'
  This generates the fundamental tables we will work with. We till haven't started filling the inventory table yet. You probably want to run this every time.
  
  3)Population-based data - many can be entered to WW eventually
  Generate simple tables with emission values derived as 'tons of pollutant per person per year'. Emission factors are either pulled from WW, or manually entered. Also apply controls or pt source subtraction if relevant.
  
  4) Pure WW pulls - can eventually be handled by WW
  Pull full emission TPY values from WW then accept them, or add controls or pt source subtraction if relevant
    
  5) Merge inventories.
    Now that we have updated all of the SCCs that we can (for now), let's merge our new data into the most up-to-date complete inventory table.
    
    
########################################################################################
########################################################################################
########################################################################################
########################################################################################
Steps 1 and 2 are executed by sourcing scripts above.

3)Population-based data
  A) this is population-based emissions where we pull EFs from the WW and population from Kem gardner. ALL OF THESE EVENTUALLY CAN COMPLETELY BE CALCULATED BY ENTERING OUR POPULATION DATA AS INPUTS FOR WW. WE WILL ONLY NEED THE BASE NUMBERS FOR WHEN WE WANT TO PROJECT OUR DATA INTO THE FUTURE.
  
  B) population-based emissions where we made our own EFs.
Both A and B could potentially have Pt source subtraction and controls applied.


TPY values will be calculated as follows:
  3.1) Identify an SCC
  3.2) Make an emission factor table for the SCC
    This is done either by manually entering EFs, or pulling them from WW
    EF tables are typically given in terms of "tons of pollutant per 'unit' per year", or TPPPY. 
  3.3) Make baseline year data. This is done by multiplying the EF table by the relevant 'unit', which is typically population or employees.
  3.4) Project baseline data. This is done by scaling the baseline data based on a given table of growth. Again, typically population or employee data.
    Now we have a pure, projected baseline of emissions to work with. We now apply       controls and remove pt sources if relevant
  3.5) OPTIONAL: Apply controls. Select which counties to control, the starting year, ending year, and starting and ending control values for any control phase-in.
  3.6) OPTIONAL: Pt source subtraction. Pull all potential Pt source SCCs that would overlap with the Area source SCC. 
      Project out the Pt source emissions and THEN subtract them away from the Area SCC.
  3.7) Add this new projected, controlled, pt_subtracted emission data to our final table.
  
make scc
get efs
make baseline
project baseline
  if pt subtract
    make pt subtract baseline
    project pt subtraction
  if controls
    apply controls
add to final table


2810010000 - perspiration - report? find citation?
switch projection methods to the new 'project baseline with same input' function to
drop a line of code from most SCCs
```{r 3) population based data}

#                               manually calculate

#1) Emission factors are from EPA's "Emission Inventory Improvement Program (EIIP)," Vol. III, (6/21/99 ed), section "Area Source Category Method Abstract - Bakeries."										
#2) Product Consumption factor is from EIIP, Vol. III, (6/21/99 ed), section "Area Source Category Method Abstract - Bakeries."										
#3) (I AM CURRENTLY NOT DOING THIS FILTERING STEP) Bakeries that distribute outside of Utah are disregarded in the double counting process (i.e. Interstate Brands and Pepperidge Farms).
#4) An EPA memo (that is cited in the EIIP document) suggests using the lower value of the range for sponge-dough emissions; i.e., 5.0 lbs VOC/1000 lbs product.										
#5) The "Estimated Consumption Fractions" were adjusted to 25% and 75% to achieve the 5.0 value suggest by that EPA memo.										
#bakeries, yeast
# Straight dough is 0.5 lb VOC/1000 lb product. 25% of product
# Sponge dough is 6.5 lb VOC/1000 lb, 75% of product
# 0.5(0.25) + 6.5(0.75) = 
#   5 lb VOC/1000 lb mixed product
# assume 70 lb of bread per person per year
# 
# Population * 70 lb/person * 1 klb/1000 lb * 5 lb VOC/ klb * 1 TPY/2000lb 
#   Population * 70/1000*5/2000
#   Population * 350/2,000,000
#     Population * 1.75E-4 = TPY VOC
scc <- 2302050000
pollutants <- c('VOC')
TPPPY <-(1.75E-4)
efs_table <- data.frame(pollutants,TPPPY)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,pp)
#no controls
#every SCC with 302032XX. Manually inputting this one
pt_sccs <- seq.int(30203201,30203299)
pt_pols <- c('VOC')
pt_table <- pull_pt_removal_table(pt_sccs,pt_pols,scc,raw_scc_pull_return = FALSE)
pt_table <- project_baseline(pt_table,pp)
temp_table <- subtract_pt_sources(pt_table,temp_table)
final_table <- rbind(final_table, temp_table)


#percent of households that own pets is from American Veterinary Medical 
#  Association 2018 report. (main_workbook/references/2806XXXXXX)
#  24.7% of households own cats in Utah
#
#googled people per household in utah, ballpark is sufficient, but got from Kem Gardner
#  people/household for utah
#  https://gardner.utah.edu/wp-content/uploads/UtahAtAGlance_20180207.pdf
#  3.19 people/household
#
#The emission factor is from, "Development of an Updated Gridded Ammonia Emission Inventory for the South Coast Air Basin."
#  0.348 lb/cat/year
#
#ammonia, domestic cats
#based on, and projects with population
#  3.19 people/house
#  24.7% of houses own cats
#  0.348 lb/cat/year = 1.74 E-4 T/cat/year
#    population * 1 house/3.19 population * 0.247 cat/house * 1.74E-4Ton/cat/year
#    1/3.19*.247*1.74E-4
# 1.35E-5 TPPPY
scc <- 2806010000
pollutants <- c('NH3')
TPPPY <-(1.35E-5)
efs_table <- data.frame(pollutants,TPPPY)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,pp)
#no controls
#no pt source
final_table <- rbind(final_table, temp_table)

#percent of households that own pets is from American Veterinary Medical 
#  Association 2018 report. (main_workbook/references/2806XXXXXX)
#  36.2% of households own dogs in Utah
#
#googled people per household in utah, ballpark is sufficient, but got from Kem Gardner
#  people/household for utah
#  https://gardner.utah.edu/wp-content/uploads/UtahAtAGlance_20180207.pdf
#  3.19 people/household
#
#The emission factor is from, "Development of an Updated Gridded Ammonia Emission Inventory for the South Coast Air Basin."
#  2.17 lb/dog/year
#
#based on, and projects with population
#  3.19 people/house
#  36.2% of houses own cats
#  2.17 lb/dog/year = 1.085E-3 T/dog/year
#    population * 1 house/3.19 population * 0.362 dog/house * 1.085E-3Ton/dog/year
#    1/3.19*.362*1.085E-3
# 1.23E-4 TPPPY
scc <- 2806015000
pollutants <- c('NH3')
TPPPY <-(1.23E-4)
efs_table <- data.frame(pollutants,TPPPY)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,pp)
#no controls
final_table <- rbind(final_table, temp_table)

#human perspiration, respiration, cigarette smoking
#all ammonia
#confusing. SAYS this is no longer reported due to lack of documentation,
#but it IS reported. It also says to contact Maine. So I did... We will see. Maine could not help haha.
#1) Emission factors from SCAQS, appendix G, pages G2 through G-3.
#2) SCAQS is an abbreviation for the document entitled "Development of the Ammonia Emission Inventory for the Southern California Air Quality Study."
#3) That document was prepared by the Radian Corporation, September 1991.
#4) Human Perspiration is estimated at 0.55 lbs ammonia per person per year.
#5) Human Respiration is estimated at 0.0035 lbs ammonia per person per year.
#6) Cigarette smoking is estimated at 0.022 lbs ammonia per person per year.
#7) Sum of the above 3 factors is 0.5755 lbs ammonia per person per year.
#2.88E-4 TPPPY
scc <- 2810010000
pollutants <- c('NH3')
TPPPY <-(2.88E-4)
efs_table <- data.frame(pollutants,TPPPY)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,pp)
#no controls
#no pt subtraction
final_table <- rbind(final_table, temp_table)

#structure fires
#1) Guidance used is from the "Emission Inventory Improvement Program (EIIP)," Vol. III, (1/31/01 ed.), Chapter 18, "Structure Fires."
#2) Emission factors are from EIIP, Vol. III, Chapter 18, "Structure Fires," (1/31/01 ed.), Table 18.4-1.
#3) Calculations include fires in buildings and other fixed structures of all types.
#4) Fires are indexed to human population; counties with more people equates to more fires.
#5) HAPs emission factors are from "Documentation for the 1999 Base Year Nonpoint Area Source National Emission Inventory for Hazardous Air Pollutants."
#6) Seasonal activity factors are from EPA's Emissions Inventory Improvement Plan Table 1.4-3.

#2.3 fires/1000 people
#1.2 tons burned per fire
#  so 2.76 tons burned per 1000 people
#  0.00276 tons per person
#
#VOC 11 lb/ton burned
#  1.52E-5 TPPPY
#PM (10 and 2.5) 10.8 lb/ton
#  1.49E-5 TPPPY
#CO 60 lb/ton
#  8.28E-5 TPPPY
#NOx 1.4 lb/ton
#  1.93E-6 TPPPY
#Acrolein (107028) 4.414 lb/ton
#  6.09E-6 TPPPY
#Hydrogen Cyanide (74908) 35.486 lb/ton
#  4.90E-5 TPPPY
#Hydrogen Chloride (7647010) 15.112 lb/ton
#  2.09E-5 TPPPY
#Formaldehyde (50000) 1.023 lb/ton
#  1.41E-6 TPPPY
scc <- 2810030000
pollutants <- c('VOC','PM10','PM25','CO','NOX','107028','74908','7647010','50000')
TPPPY <-c(1.52E-5,1.49E-5,1.49E-5,8.28E-5,1.93E-6,6.09E-6,4.90E-5,2.09E-5,1.41E-6)
efs_table <- data.frame(pollutants,TPPPY)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,pp)
#no controls
final_table <- rbind(final_table, temp_table)

#vehicle fires
#1) EPA's "Emission Inventory Improvement Program (EIIP)," Volume III, "Area Sources Category Method Abstract - Vehicle Fires," (5/15/00 edition) is used. Material burned is in the text on page 1.
#2) The EIIP gives emission factors for PM, CO, NOx, nonmethane total organic compounds, and methane.
#3) The "nonmethane total organic compounds" is assumed equal to VOC. Methane is ignored.
#5) Fires per 1000 people derived by averaging 2010-2013 summary & "by FDID" data on the Utah Fire Incident Reporting System, Utah Fire Marshal's Office at: https://site.utah.gov/publicsafety/firemarshal/nfirs.html. NOTE: To conform with EIIP methods, water, rail and aircraft vehicle fires were excluded, only fire codes 130-132, and 136-138 were summed each year.

#Vehicle Fire Data
#*Note in 2012, only summary data is available and water/rail/air fires could not be excluded.	
#Year	              2010 2011	2012*	2013						
#Incidents	        804  758  702	  646						
#Avg Yearly Fires   727.5						
#Per 1000 people		0.232903894						

#0.2329 fires/1000 ppl
#2.33E-4 fires/person
#0.25 Tons burned per car
#  5.825E-5 Tons burned per person

#PM (10 and 2.5) 100 lb/ton
#  2.91E-6 TPPPY
#NMOC (assumed to be VOC) 32 lb/ton
#  9.32E-7 TPPPY
#CO 125 lb/ton 
#  3.64E-6 TPPPY
#NOx 4 lb/ton
#  1.16E-7 TPPPY
scc <- 2810050000
pollutants <- c('PM10','PM25','VOC','CO','NOX')
TPPPY <- c(2.91E-6,2.91E-6,9.32E-7,3.64E-6,1.16E-7)
efs_table <- data.frame(pollutants,TPPPY)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,pp)
#no controls
final_table <- rbind(final_table, temp_table)

#FIFRA products, solvents. (Federal Insecticide, Fungicide, and Rodenticide Act)
#1) Emission Factors and calculation methods from EPA/NOMAD (for the 2014 NEI). Note: Activity data was based on USGS report “Estimated Annual Agricultural Pesticide Use for Counties of the Conterminous United States, 2008-2012”.												
#2) based on population
#2) projects based on agJobs
scc <- 2460800000
efs_table <- pull_efs_from_ww_with_secondaries(scc)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,pp)
#no controls
final_table <- rbind(final_table, temp_table)

#solvent, personal care
#based on EPA NOMAD method
#baseline and projection on population
#1) Control percent phase in provided by Utah DAQ's Joel Karmazyn based on existing rules. Phase in was conservatively calculated to begin in 2014.						
scc <- 2460100000
efs_table <- pull_efs_from_ww_with_secondaries(scc)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,pp)
counties <- c(49003, 49005, 49011, 49035, 49045, 49049, 49057)
# rule R307-357, https://rules.utah.gov/publicat/code/r307/r307-357.htm
# "assume first product hit shelf in 2016"
# it is not clear from rule 357 what the control efficiency is, you have to
# look at our 2017 TSD. This applies for all 357-controlled SCCs
temp_table <- add_controls(temp_table,scc,counties,2015,2016,0.916)
final_table <- rbind(final_table, temp_table)

#solvent, household products
#based on EPA NOMAD method
#baseline and projection on population
#1) Control percent phase in provided by Utah DAQ's Joel Karmazyn based on existing rules. Phase in was conservatively calculated to begin in 2014.						
scc <- 2460200000
efs_table <- pull_efs_from_ww_with_secondaries(scc)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,pp)
counties <- c(49003, 49005, 49011, 49035, 49045, 49049, 49057)
# rule R307-357, https://rules.utah.gov/publicat/code/r307/r307-357.htm
# see 2460100000
temp_table <- add_controls(temp_table,scc,counties,2015,2016,0.755)
final_table <- rbind(final_table, temp_table)

#solvent, auto aftermarket products
#based on EPA NOMAD method
#baseline and projection on population
#1) Control percent phase in provided by Utah DAQ's Joel Karmazyn based on existing rules. Phase in was conservatively calculated to begin in 2014.						
scc <- 2460400000
efs_table <- pull_efs_from_ww_with_secondaries(scc)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,pp)
counties <- c(49003, 49005, 49011, 49035, 49045, 49049, 49057)
# rule R307-357, https://rules.utah.gov/publicat/code/r307/r307-357.htm
# see 2460100000
temp_table <- add_controls(temp_table,scc,counties,2015,2016,0.936)
final_table <- rbind(final_table, temp_table)

#solvent, coatings & related products
#based on EPA NOMAD method
#baseline and projection on population
#1) Control percent phase in provided by Utah DAQ's Joel Karmazyn based on existing rules. Phase in was conservatively calculated to begin in 2014.						
scc <- 2460500000
efs_table <- pull_efs_from_ww_with_secondaries(scc)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,pp)
counties <- c(49003, 49005, 49011, 49035, 49045, 49049, 49057)
# rule R307-357, https://rules.utah.gov/publicat/code/r307/r307-357.htm
# see 2460100000
temp_table <- add_controls(temp_table,scc,counties,2015,2016,0.913)
final_table <- rbind(final_table, temp_table)

#solvents, adhesives and sealants
#based on EPA NOMAD method
#baseline and projection on population
#1) Control percent phase in provided by Utah DAQ's Joel Karmazyn based on existing rules. Phase in was conservatively calculated to begin in 2014.						
scc <- 2460600000
efs_table <- pull_efs_from_ww_with_secondaries(scc)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,pp)
counties <- c(49003, 49005, 49011, 49035, 49045, 49049, 49057)
# rule R307-357, https://rules.utah.gov/publicat/code/r307/r307-357.htm
# see 2460100000
temp_table <- add_controls(temp_table,scc,counties,2013,2018,0.49)
final_table <- rbind(final_table, temp_table)

#solvents, consumer use, miscellaneous 
#based on EPA NOMAD method
#baseline and projection on population
scc <- 2460900000
efs_table <- pull_efs_from_ww_with_secondaries(scc)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,pp)
#no controls
final_table <- rbind(final_table, temp_table)



#                               Pull from WW but manually project
#non-industrial commercial pesticides
#1) Emission Factors and calculation methods from EPA/NOMAD (for the 2014 NEI). Note: Activity data was based on USGS report “Estimated Annual Agricultural Pesticide Use for Counties of the Conterminous United States, 2008-2012”.												
#2) based on WW (agjobs p sure)
#3) projects based on agjobs
scc <- (2461850000)
temp_table <- pull_baseline_from_ww(scc) 
temp_table <- project_baseline(temp_table, AgJobs)  
#no controls
final_table <- rbind(final_table, temp_table)

#Open burning land clearing
#scales with population
#7) Emissions for this SCC projected as zero - as this type of burning is not typically practiced in Utah and no burning of cleared debris (slash) from a  construction project was permitted in 2014 per State Fire Marshall Coy Porter. Therefore, activity data was set at zero tons of debris burned for all counties.										
# EPA estimates emissions from this SCC on the order of 12,000 TPY of CO, so zeroing it is kind of a big deal. Do we have any methods to track illegal burning?
scc <- 2610000500
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,pp)
counties <- seq.int(49001,49057,2)
#here is where we turn everything into zeros
temp_table <- add_controls(temp_table,scc,counties,1900,1901,0)
final_table <- rbind(final_table, temp_table)

#unpaved roads emissions
#baseline from WW
#projection based on AgJobs
#4) Projection is based on agricultural employment growth. This was employed as agricultural operations are anticipated to represent a large portion of unpaved road use. Agriculture is also a better projection than population growth as typcially propulation growth result in development of agricultural lands and paving of previously unpaved roads (population growth would be more likely to be inversly related to unpaved road dust emissions). While agricultural employment will not account for recreational use of unpaved roads, this was considered moot as population increases may increase recreational uses however that same population growth also reduces the amount of unpaved roads.
scc <- 2296000000
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,AgJobs)
#no controls
#there is probably some pt source subtraction I could do here, but none for now
final_table <- rbind(final_table, temp_table)

#LUST - Leaking Underground Storage Tanks
#baseline based on number of remediation events in a given year from DERR
#projection based on average past 5 years
#1) Each remediation is estimated to release 28 lbs/day based on “Emission Inventory Improvement Program (EIIP),” Vol. III, “Area Source Category Method Abstract-Remediation of Leaking Underground Storage Tanks”											
#2) Each remediation is assumed to last a full 12 months.											
#3) Each remediation is assumed to occur in the year it began.											
#4) The number of remediation events was measured by DEQ-DERR, Sean Warner, 536-4163.	
scc <- 2660000000
#pull all years because of how the projection is calculated
input_table <- shame_pull_input_table_from_workbook('LUST',st_year = 2014, e_year = 2050)
pollutants <- c('VOC')
TPPPY <-(5.11)
efs_table <- data.frame(pollutants,TPPPY)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,input_table)
final_table <- rbind(final_table, temp_table)
```

need to add these SCCs
```{r} 



#                    pull from WW - with secondary pollutants
#surface coatings, architectural
scc <- 2401001000
#make and project baseline
efs_table <- pull_efs_from_ww_with_secondaries(scc)
temp_table <- project_baseline_with_same_input_data(scc,efs_table,input_table)
#make and project pt subs

#apply controls
counties <- c(49003, 49005, 49011, 49035, 49045, 49049, 49057)
temp_table <- add_controls(temp_table,scc,counties,2015,2016,0.45)
pt_sccs <- seq.int(30203201,30203299)
pt_pols <- c('VOC')
pt_table <- pull_pt_removal_table(pt_sccs,pt_pols,statewide_compiled,scc,base_year)
pt_table <- project_baseline(pt_table,pp,base_year,project_to_year)
temp_table <- subtract_pt_sources(pt_table,temp_table)
final_table <- rbind(final_table, temp_table)



```

  4) Pure WW pulls - can eventually be handled by WW
  Pull full emission TPY values from WW then accept them, or add controls or pt source subtraction if relevant
    These data are calculated the same as WW, but we calculate them ourselves. This may be so we can control the data, or pt subtract from it. Either way, EVENTUALLY THIS CAN BE COMPLETELY HANDLED BY THE WW. WE WILL JUST HAVE TO SUPPLY INPUTS.
    
```{r ww pulls}
sccs <- c(2104004000,
          2296000000,
          2302002200,
          2302003000,
          2302003100,
          2302003200,
          2501055120,
          2505040120,
          2801000003,
          2810025000,
          2810060100,
          2810060200)
raw_sccs_from_ww <- pull_sccs_from_ww(sccs)
#add a column for year
raw_sccs_from_ww <- mutate(raw_sccs_from_ww, year = start_year)
raw_sccs_from_ww <- raw_sccs_from_ww[c('StateAndCountyFIPSCode','SourceClassificationCode','year','PollutantCode','TotalEmissions')]
colnames(raw_sccs_from_ww) <- c('FIPS','SCC','year','pollutant','TPY')
raw_sccs_from_ww <- consolidate_xylenes(raw_sccs_from_ww, c(2104008210, 2104008230, 2104008310, 2104008330, 2810025000))
final_table <- rbind(final_table, raw_sccs_from_ww)

```

```{r combustion!}

#SIP_compiled <-
#  read_xlsx(
#    'U:/PLAN/SIP/Ozone/2015 Standard/Episodic Inventories/TSD Writeup/Area/2017 Supporting Documents/5.26.2020 New Point File for Kristy ozone marginal.xlsx')
#sip_ids<- unique(SIP_compiled$`Site ID`)
                                    #Natural Gas
                                    #Natural Gas
                                    #Natural Gas
#industrial NG boilers/ICEs
scc <- 2102006000
thru_unit <- 'E6FT3'
#throughput is MMCF
efs_table <- pull_efs_from_ww_all_primaries(scc,throughput_unit = 'E6FT3')
#the gas company (Dominion Energy) makes the distinction between
#  Residential, and 
#  Non-residential (Electrical/Industrial/Commercial)
#we will pull the non-residential statewide throughput, 
#and from it we will pull the industrial portion
non_resident_ng_table <- 
  shame_pull_input_table_from_workbook('ComNatGas',
                                       convert_fips = FALSE, 
                                       throughput_unit = thru_unit) %>%
  filter(year == start_year) 
non_resident_ng <- non_resident_ng_table[[1,3]]
#now find out how much is pure_industrial
#*Questar's 2014 usage consumption proportions provided by Dave Landward were: 
#Residential - 36%
#Commercial - 22%
#Industrial - 19% and 
#Electric - 23%.  
#so of the non-residential, we can divvy things out further.
ind_portion <- 19/(22+19+23)
#remember this is MMCF
raw_ind_ng <- non_resident_ng*ind_portion
#now we get the pt source throughput of NG. let's pull it from the SLEIS data dump
ind_naics <- c(21, 31:33)
materials <- 'Natural Gas'
test_sip <- pull_pt_material_throughput(materials,ind_naics,SIP_ids_to_filter = sip_ids)




fac_id <- 10716 #us mag

fac_id <- 10209 #kinder morgan altamont east
fac_id <- 10210 #kinder morgan altamont west

fac_id <- 10327 #intermountain power service corporation

sleis <- sleis_raw %>% filter(`Facility Identifier` == fac_id)
comb <- SIP_temp_comb_t %>% filter(`Site ID` == fac_id)

sort(unique(sleis$`SCC (Code)`))
sort(unique(comb$SCC))

temp_scc <- 20100201
sleis %>% filter(`SCC (Code)`== temp_scc) %>% select(Throughput) %>% sum()
comb %>% filter( SCC == temp_scc) %>% select(Throughput) %>% sum()

sleis %>% select(Throughput) %>% sum()
comb %>% select(Throughput) %>% sum()





  #pull raw data from SLEIS
sleis_raw <- pull_pt_material_throughput(materials,ind_naics,SIP_ids_to_filter = sip_ids,raw_pull_return = TRUE)

#pull a list of all the sites
sort(unique(test_sip$`Facility Identifier`)) #37,033 MMCF, now 42,608 MMCF
sort(unique(SIP_temp_comb_t$`Site ID`)) #23,452 MMCF

#get a list of all facilities that show up in sleis and combustion table
shared_ids <- sort(unique(SIP_temp_comb_t$`Site ID`))
shared_ids <- append(shared_ids,11386)

#go through each facility and give throughput for SLEIS and combustion table
for (cur_id in shared_ids){
  cat(cur_id)
  cat('\nSLEIS\n')
  a <-test_sip %>% filter(`Facility Identifier` == cur_id) %>% select(Throughput) 
  if(dim(a)[1]==0){
    cat(0)
  } else{
  cat(sum(a))
  }
  cat('\nCOMBUSTION TABLE \n')
  a<- SIP_temp_comb_t %>% filter(`Site ID` == cur_id) %>% select(Throughput)
  if(dim(a)[1]==0){
    cat(0)
  } else{
  cat(sum(a))
  }
  cat('\n\n')
}

```

```{r wood burning WW pulls}
#see '2104008XXX_woodstoves.xlsx' in main_workbook folder
sccs <- c(2104008100,
          2104008210,
          2104008220,
          2104008230,
          2104008310,
          2104008320,
          2104008330,
          2104008400,
          2104008510,
          2104008610,
          2104008700,
          2104009000)
wood_sccs <- pull_sccs_from_ww(sccs)
#add a column for year
wood_sccs <- mutate(wood_sccs, year = start_year)
wood_sccs <- wood_sccs[c('StateAndCountyFIPSCode','SourceClassificationCode','year','PollutantCode','TotalEmissions')]
colnames(wood_sccs) <- c('FIPS','SCC','year','pollutant','TPY')
wood_sccs <- consolidate_xylenes(wood_sccs, c(2104008210, 2104008230, 2104008310, 2104008330))
#add controls
#I added these controls 9/10/2020 to account for our success in replacing wood stoves with NG heating. Practically speaking, each stove replaced should be reflected with a lower tonnage of wood burned, but we were only reading the WW output, so the reduction was reached with a different method.
#Each stove replaced translates to a lower wood burned throughput, which leads to lower emissions. I added a control to each SCC/County that would reduce emissions an equal amount to this lower wood throughput. This control scales with the SCC growth, which I am comfortable assuming, as the replacement program is ongoing.

#All of the stoves removed and TPY's reduced were spread out over the Salt Lake NAA. The reduction quantities were distributed as follows:
#Box Elder County 5.4%
#Davis County 25.1%
#Salt Lake County 57.6%
#Tooele County 1.3%
#Weber County 10.6%

#assume wood density of 1.04 Tons/Cord
#most up-to-date emission factors are in the WW tool
#352 of all of the units were replaced in 2018, so I assumed a complete phase-in finished for 2018. This is a rough approximation, but is accurate enough.
controlled_wood_sccs <- wood_sccs

#wood fireplace, general
#685 units removed at 0.08234 cords/unit/year
#PM25-PRI reduced 0.6906 TPY
scc <- 2104008100
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49003, 
               start_year = 2017,end_year = 2018, 
               end_val = 0.98326 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49011,
               start_year = 2017,end_year = 2018, 
               end_val = 0.98450 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49035,
               start_year = 2017,end_year = 2018, 
               end_val = 0.98781 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49045,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99653 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49057,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99264 )

#Woodstove, fireplace insert, non-EPA certified
# 70 units at 0.1135 cords/unit/year
# PM25-PRI reduced 0.1261
scc <- 2104008210
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49003, 
               start_year = 2017,end_year = 2018, 
               end_val = 0.97621 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49011,
               start_year = 2017,end_year = 2018, 
               end_val = 0.98321 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49035,
               start_year = 2017,end_year = 2018, 
               end_val = 0.98817 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49045,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99498 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49057,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99140 )

#woodstove, freestanding, non-EPA certified
#117 units at 0.2825 cords/unit/year
#PM25-PRI reduced 0.5248 TPY
scc <- 2104008310
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49003, 
               start_year = 2017,end_year = 2018, 
               end_val = 0.98542 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49011,
               start_year = 2017,end_year = 2018, 
               end_val = 0.98229 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49035,
               start_year = 2017,end_year = 2018, 
               end_val = 0.98526 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49045,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99653 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49057,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99390 )
#woodstove, freestanding, EPA certified, non-catalytic
#2 units at 0.2825 cords/unit/year
#PM25-PRI reduced 0.002568 TPY
scc <- 2104008320
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49003, 
               start_year = 2017,end_year = 2018, 
               end_val = 0.99981 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49011,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99977 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49035,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99981 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49045,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99996 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49057,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99992 )

#woodstove, pellet-fired, general (freestanding or FP insert)
#11 units at 0.1223 cords/unit/year
#PM25-PRI reduced 0.002135 TPY
scc <- 2104008400
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49003, 
               start_year = 2017,end_year = 2018, 
               end_val = 0.99817 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49011,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99892 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49035,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99939 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49045,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99954 )
controlled_wood_sccs <- 
  add_controls(controlled_wood_sccs,
               scc,
               counties = 49057,
               start_year = 2017,end_year = 2018, 
               end_val = 0.99958 )

final_table <- rbind(final_table, controlled_wood_sccs)
```

  5) Merge inventories.
    Now that we have updated all of the SCCs that we can (for now), let's merge our new data into the most up-to-date complete inventory table.
    5.1) Identify every SCC in our new table
    5.2) remove those SCCs from the old inventory table. Keep all the old inventory sccs that weren't modified with this script.
    5.3) Merge together the old, unmodified SCCs with the new SCCs. 
    5.3X) OPTIONAL: Consolidate PM by removing PM10-FIL, PM-CON, PM25-FIL, and changing the names of PM10-PRI/PM25-PRI to PM10/PM25.
    5.3Y) OPTIONAL: Consolidate Xylenes by removing O, P, and M-Xylenes and grouping them all as Xylenes-Total.
    5.4) Save that final table
    
```{r merge inventories}
advanced_sccs <- unique(final_table$SCC)
old_model_filtered_sccs <- old_model_data %>% filter(! SCC %in% advanced_sccs)

final_table <- rbind(old_model_filtered_sccs,final_table)




```
`



```{r dead functions}

listify <- 
  function(intable){
    
    #I will make three vectors, one for each column. Then I will merge them.
    cts  <- vector()
    yrs  <- vector()
    pops <- vector()
    county_names <- intable[,1]
    
    years <- colnames(intable)
    #cut off the first column of county names
    years <- years[2:length(years)]
    years <- as.integer(years)
    
    for (cur_year in years) {
      for (cur_county_pos in (1:nrow(county_names))) {
        #fill in the three vectors
        ct <- county_names[[cur_county_pos, 1]]
        yr <- cur_year
        pop <- intable[[cur_county_pos, toString(yr)]]
        
        cts <- append(cts, ct)
        yrs <- append(yrs, yr)
        pops <- append(pops, pop)
        
      }
      
    }
  outtable <- data.frame(cts,yrs,pops)
  names(outtable) <- c('county','year','population')
  return(outtable)
  }



#

```