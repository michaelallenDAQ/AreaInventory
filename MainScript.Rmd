---
title: "AreaInventory"
output: html_document

editor_options:
  chunk_output_type: console
---

```{r optional SIP stuff, or Website/NEI filters}
#for the ozone SIP. This is the list of all pt sources to filter for the 2017 inventory
#SIP_compiled <- read_xlsx(
#    'U:/PLAN/SIP/Ozone/2015 Standard/Episodic Inventories/TSD Writeup/Area/2017 Supporting Documents/5.26.2020 New Point File for Kristy ozone marginal.xlsx')
#SIP_ids <- sort(unique(SIP_compiled$`Site ID`))

#I'll just declare the IDs here, but you can pull these numbers from running the code above.
#Ozone_SIP_ids
target_ids <- c(10007,10008,10009,10028,10096,10107,10119,10121,10122,10123,10129,10209,10210,
                   10211,10237,10238,10259,10303,10311,10313,10327,10335,10346,10354,10355,10571,
                   10572,10627,10676,10706,10707,10716,10725,10790,10794,10892,11284,11386,11532,
                   11767,12495,12512,12524,12929,12948,13031,13284,14107,14185,15438,15439)
########################################################
#for the 2017 NEI
#NEI_compiled <- read_xlsx('U:/PLAN/CYOUATT/NEI/2017/2017 SLEIS EIS Facility List - Updated.xlsx')
#NEI_2017_ids <- sort(unique(NEI_compiled$`Site ID`))

#or I'll just declare them here
#NEI_2017_ids 
target_ids <- c(10007,10008,10009,10028,10034,10096,10107,10119,10120,10121,10122,10123,10129,
                  10156,10209,10210,10211,10237,10238,10259,10303,10311,10313,10327,10335,10346,
                  10348,10354,10355,10369,10406,10414,10420,10423,10491,10555,10562,10565,10571,
                  10572,10627,10676,10706,10707,10716,10725,10790,10794,10819,10823,10825,10843,
                  10880,10892,10917,10922,11199,11234,11284,11386,11408,11532,11664,11767,11966,
                  11977,12495,12512,12524,12825,12929,12948,13031,13043,13104,13144,13284,13315,
                  14010,14107,14185,15438,15487)

#Web IDs is just every single site.
target_ids <- NULL
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = Sys.getenv('HomeDir'))
```


```{r run this always}
library(readxl)
library(tidyverse)
library(tidyr)

#turn off scientific notation. Scientific notation is bad when listing SCCs, as often the end
#digits get cut off
options(scipen = 999)

#step 1
source(paste0(Sys.getenv('GitDir'),'BaseCodes.R'))
start_year <- 2017
end_year <- 2020
#when we add controls to an SCC, these are the default FIPS we add controls to.
naa_counties <- c(49003, 49005, 49011, 49035, 49045, 49049, 49057)
#step 2
source(paste0(Sys.getenv('GitDir'),'BaseTables.R'))
#this one I am phasing out, so I will comment it
#source(paste0(Sys.getenv('GitDir'),'BaseInputs.R'))

#we will fill in this final table with our data
final_table <- vector()
```


```{r}
#run this line if I'm tinkering with input tables
#input_table_path <- "ref_workbooks/new_input_tables20210305.xlsx"
#input_tables <- pull_input_tables(paste0(Sys.getenv("HomeDir"),"/",input_table_path))

#then go to BaseTables and run the 2 project_tables lines

```


This is going to produce a fresh inventory for Utah's Area Source.
This code has 5 main sections:
  1) Base Codes
  Always run this section. 'source('basecodes.R')'. This pull functions you will use later in the script. This section should not pull any variables. It should only generate functions.
  
  2) Base tables/base_inputs
  'source('baseTables.R')'
  'source('base_inputs.R')'
  This generates the fundamental tables we will work with. We till haven't started filling the inventory table yet. You probably want to run this every time.
  
  3.x)Generate data from scratch - find EFs from online sources
  If our SCC is not in the WW, we have to develop emission estimates from scratch. This is not ideal, and requires
  lots of documentation.
  
  3.x) Pull EFs from WW
  Our data can be based on whatever throughput or population, but we are pulling EFs from the WW and then
  creating baseline emissions and projections with our own numbers.
  
  3.x) Pull baseline from WW
  Pull the entire baseline of emissions from the WW. All we do from this point is project the data and 
  maybe add controls.
  
  5) Merge inventories.
    Now that we have updated all of the SCCs that we can (for now), let's merge our new data into the most up-to-date complete inventory table.
    
    
########################################################################################
########################################################################################
########################################################################################
########################################################################################
Steps 1 and 2 are executed by sourcing scripts above.

3)Population-based data
  A) this is population-based emissions where we pull EFs from the WW and population from Kem gardner. ALL OF THESE EVENTUALLY CAN COMPLETELY BE CALCULATED BY ENTERING OUR POPULATION DATA AS INPUTS FOR WW. WE WILL ONLY NEED THE BASE NUMBERS FOR WHEN WE WANT TO PROJECT OUR DATA INTO THE FUTURE.
  
  B) population-based emissions where we made our own EFs.
Both A and B could potentially have Pt source subtraction and controls applied.


TPY values will be calculated as follows:
  3.1) Identify an SCC
  3.2) Make an emission factor table for the SCC
    This is done either by manually entering EFs, or pulling them from WW
    EF tables are typically given in terms of "tons of pollutant per 'unit' per year", or TPUPY. 
  3.3) Make baseline year data. This is done by multiplying the EF table by the relevant 'unit', which is typically population or employees.
  3.4) Project baseline data. This is done by scaling the baseline data based on a given table of growth. Again, typically population or employee data.
    Now we have a pure, projected baseline of emissions to work with. We now apply controls and remove pt sources if relevant
    3.4.1) OPTIONAL: Pt source subtraction. Pull all potential Pt source SCCs that would overlap with the Area source SCC. We must project out the Pt source emissions and THEN subtract them away from the Area SCC. Ideally, we subtract uncontrolled pt source emissions from uncontrolled area source emissions.
    3.4.2) OPTIONAL: Apply controls. Select which counties to control, the starting year, ending year, and starting and ending control values for any control phase-in. Ideally, we add controls after subtracting pt sources.
  3.5) Add this new projected, controlled, pt_subtracted emission data to our final table.
  
make scc
get efs
make baseline
project baseline
  if pt subtract
    make pt subtract baseline
    project pt subtraction
  if controls
    apply controls
add to final table
```{r}




```


This section is for SCCs that Utah does not generate numbers for. This section includes a lot of agricultural emissions, some crop burning, and some others. EPA will generate these numbers for us and our NEI. Once EPA gives us these numbers, we can use the data for our website inventory, and also use it for SIP projections, but we should NOT use these SCCs for NEI reporting. We want EPA to take precedence on these numbers for NEI reporting, and if we report these in the NEI, we will over-write whatever EPA comes up with.

To calculate emissions for animal agriculture, EPA uses a complicated model. We can send them custom throughput (# of animals in each county) to go into the model if we choose to do so before each NEI inventory. However, we do not get emissions factors from the WW, etc., we just get the final resulting total emissions per county from the NEI workbook when it is released. We're just going to pull total emissions from the NEI for these agriculture sccs, and then we can project based on agricultural employment. 

There are no rules (and therefore, no controls) or pt source subtractions for these sccs.


```{r Pull from NEI, for SIP/Website, NOT for NEI reporting}

# Miscellaneous Area Sources > Agriculture Production - Livestock > Poultry production - turkeys > Confinement
# Get total emissions from NEI; project based on agricultural employment.
scc <- 2805010100

# Total emissions come from a model
temp_table <- pull_baseline_from_nei(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])

# No controls & no pt source subtractions for agricultural livestock sccs
temp_table_final <- temp_table_project
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_final)


# Miscellaneous Area Sources > Agriculture Production - Livestock > Swine production composite > Not Elsewhere Classified (see also 28-05-039, -047, -053)
# Get total emissions from NEI; project based on agricultural employment
scc <- 2805025000
# Total emissions come from a model
temp_table <- pull_baseline_from_nei(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])
# No controls & no pt source subtractions for agricultural livestock sccs
temp_table_final <- temp_table_project
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_final)


# Miscellaneous Area Sources > Agriculture Production - Livestock > Poultry Waste Emissions > Not Elsewhere Classified (see also 28-05-007, -008, -009)
## Note: This scc was in the workbook as 2805030000, but all that it was was the emissions from 2805007100, so we are going to stop using 2805030000 and replace it with 2805007100.

# Get total emissions from NEI; project based on agricultural employment.
scc <- 2805007100
# Total emissions come from a model
temp_table <- pull_baseline_from_nei(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])
# No controls & no pt source subtractions for agricultural livestock sccs
temp_table_final <- temp_table_project
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_final)


# Miscellaneous Area Sources > Agriculture Production - Livestock > Horses and Ponies Waste Emissions > Not Elsewhere Classified
# Get total emissions from NEI; project based on agricultural employment.
scc <- 2805035000
# Total emissions come from a model
temp_table <- pull_baseline_from_nei(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])
# No controls & no pt source subtractions for agricultural livestock sccs
temp_table_final <- temp_table_project
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_final)


# Miscellaneous Area Sources > Agriculture Production - Livestock > Sheep and Lambs Waste Emissions > Total
# Get total emissions from NEI; project based on agricultural employment.
scc <- 2805040000
# Total emissions come from a model
temp_table <- pull_baseline_from_nei(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])
# No controls & no pt source subtractions for agricultural livestock sccs
temp_table_final <- temp_table_project
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_final)


# Miscellaneous Area Sources > Agriculture Production - Livestock > Goats Waste Emissions > Not Elsewhere Classified
# Get total emissions from NEI; project based on agricultural employment.
scc <- 2805045000
# Total emissions come from a model
temp_table <- pull_baseline_from_nei(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])

# No controls & no pt source subtractions for agricultural livestock sccs
temp_table_final <- temp_table_project
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_final)


# Miscellaneous Area Sources > Agriculture Production - Livestock > Beef cattle production composite > Not Elsewhere Classified
# Get total emissions from the NEI; project based on agricultural employment
scc <- 2805002000
temp_table <- pull_baseline_from_nei(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])

# No controls & no pt source subtractions
temp_table_final <- temp_table_project
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this SCC
rm(scc, temp_table, temp_table_project, temp_table_final)

# Miscellaneous Area Sources > Agriculture Production - Livestock > Dairy cattle composite > Not Elsewhere Classified
# Get total emissions from NEI; project based on agricultural employment
scc <- 2805018000
temp_table <- pull_baseline_from_nei(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])

# No controls & no pt source subtractions
temp_table_final <- temp_table_project
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this SCC
rm(scc, temp_table, temp_table_project, temp_table_final)


# Miscellaneous Area Sources > Agriculture Production - Livestock > Dairy Cattle > Dust Kicked-up by Hooves
# Get total emissions from NEI; project based on agricultural employment
scc <- 2805001010
temp_table <- pull_baseline_from_nei(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])

# No controls & no pt source subtractions
temp_table_final <- temp_table_project
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this SCC
rm(scc, temp_table, temp_table_project, temp_table_final)


# Miscellaneous Area Sources > Agriculture Production - Livestock > Broilers > Dust Kicked-up by Feet
# Get total emissions from the NEI; project based on agricultural employment
scc <- 2805001020
temp_table <- pull_baseline_from_nei(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])

# No controls & no pt source subtractions
temp_table_final <- temp_table_project
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this SCC
rm(scc, temp_table, temp_table_project, temp_table_final)


# Miscellaneous Area Sources > Agriculture Production - Livestock > Swine > Dust Kicked-up by Hooves
# Get total emissions from the NEI; project based on agricultural employment
scc <- 2805001040
temp_table <- pull_baseline_from_nei(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])

# No controls & no pt source subtractions
temp_table_final <- temp_table_project
# add to final table
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this SCC
rm(scc, temp_table, temp_table_project, temp_table_final)


# Miscellaneous Area Sources > Agricultural Production - Livestock > Layers > Dust Kicked-up by Feet
# Get total emissions from the NEI; project based on agricultural employment
scc <- 2805001030
temp_table <- pull_baseline_from_nei(scc = scc)

# project on ag employment
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])

# No controls & no pt source subtractions
# Set temp_table_final equal to temp_table_project
temp_table_final <- temp_table_project

# add to final table
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this SCC
rm(scc, temp_table, temp_table_project, temp_table_final)

# Miscellaneous Area Sources > Agricultral Production - Livestock > Turkeys > Dust Kicked-up by Feet
# Get total emissions from the NEI; project based on agricultural employment
scc <- 2805001050

temp_table <- pull_baseline_from_nei(scc = scc)

# project on ag employment
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])

# No controls & no pt source subtractions
# Set temp_table_final equal to temp_table_project
temp_table_final <- temp_table_project

# add to final table
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this SCC
rm(scc, temp_table, temp_table_project, temp_table_final)

# Miscellaneous Area Sources > Agriculture Production - Livestock > Poultry Production - broilers > Confinement
# Get total emissions from the NEI; project based on agricultural employment
scc <- 2805009100

temp_table <- pull_baseline_from_nei(scc = scc)

# project on ag employment
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])

# No controls & no pt source subtractions
# Set temp_table_final equal to temp_table_project
temp_table_final <- temp_table_project

# add to final table
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this SCC
rm(scc, temp_table, temp_table_project, temp_table_final)

# Miscellaneous Area Sources > Agricultural Production - Livestock > Beef cattle - finishing operations on feedlots (drylots) > Dust Kicked-up by Hooves
# Get total emissions from the NEI; project based on agricultural employment
scc <- 2805001000

temp_table <- pull_baseline_from_nei(scc = scc)

# project on ag employment
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])

# No controls & no pt source subtractions
# Set temp_table_final equal to temp_table_project
temp_table_final <- temp_table_project

# add to final table
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this SCC
rm(scc, temp_table, temp_table_project, temp_table_final)


# Miscellaneous Area Sources > Agriculture Production - Crops - as nonpoint > Agricultural Field Burning - whole field set on fire > Unspecified crop type and Burn Method
## This scc covers the burning of crop chaff, stock, and stubble from farming fields, whether piled or in situ.
scc <- 2801500000

# Total emissions - we just get emissions estimates from the NEI.
temp_table <- pull_baseline_from_nei(scc = scc)

# Project on agricultural employment
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])

# No controls
# No pt source subtractions
# temp_table_project is our final temp_table
temp_table_final <- temp_table_project

# add to final table
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_final)


# Miscellaneous Area Sources > Agriculture Production - Crops > Fertilizer Application > Miscellaneous Fertilizers
scc <- 2801700099

temp_table <- pull_baseline_from_nei(scc = scc)
# Project on agricultural employment
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["AgJobs"]])

# No controls
# No pt source subtractions
# temp_table_project is our final temp_table
temp_table_final <- temp_table_project

# add to final table
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_final)
```


2810010000 - perspiration - report? find citation?
switch projection methods to the new 'project baseline with same input' function to
drop a line of code from most SCCs
```{r 3.1) create our own EFs - not ideal, as references can go bad}

#Misc sources > aircraft/rocket engine firing and testing > total
#this scc used to assume emissions from rocket firing and testing were "estimated to be one percent of aircraft emissions at all Utah airports. This was determined by a 1992 Division of Air Quality phone survey of aircraft maintenance staff."
#it is now focused on actual rocket testing/firing, like we would find at the ATK Promontory/Thiokol site (10009) or the ATK Bacchus plant (10402). We can eventually add inspection/maintenance of aircraft on airports, but that will be a more complex process, and they might not even apply to this scc.
scc <- 2810040000
#these pt sccs were manually pulled on 2021/04/08 by Michael Allen. I looked at sites 10009, 10402 in SLEIS and pulled every SCC that looked like it could apply to test fuel combustion. My method is sketchy, and could be improved.
#I left out 30101010 - TNT manufacturing, because it didn't seem like test rocket fuel
pt_sccs <- c(50300205,20400201)
#We assume there is no test rocket fuel burning on nonpermitted sites, so the only emissions captured in this SCC are permitted emissions that do not count as "Major Point Sources" (is_point == FALSE) for wherever we are reporting our data. All of the other processes will be captured by the point source inventory
temp_table <- pull_pt_removal_table(pt_sccs,scc) %>% filter(is_point == FALSE) %>% select(-is_point)
#project as steady. These are permitted emissions so they may not radically change over time.
temp_table <- project_baseline(temp_table,projection_tables[["Steady"]])
#no controls
final_table <- rbind(final_table,temp_table)


#industrial processes > mining and quarrying: SIC 14 > all processes
scc <- 2325000000
#all quarrying/mining should be happening on permitted sites. This SCC will simply catch all the processes that don't count as "Major Point Source" for wherever we are reporting, and it will put them in the area inventory
#these pt sccs were manually pulled on 2021/04/22 by Michael Allen. The list of SCCs may be incomplete. I took a list of every non-retired 8 digit SCC, and then searched the layer descriptions for things like "crush", "mill", "drill", "blast" etc, and then manually filtered through the resulting ~800 sccs to take out irrelevant codes. I ended with 349 SCCs. Look in main_workbook > references > 2325000000_MiningQuarryingSCCs.xlsx for the work. My method is not comprehensive, and could be improved.

#see "2325000000_Mining & quarrying NEMO 2017 FINAL_4-2" update in references. The EPA considers 4 activities for this SCC: 
#    "overburden removal, 
#    drilling and blasting, 
#    loading and unloading, and 
#    overburden replacement. 
#Not included are the 
#    transfer and conveyance operations, 
#    crushing and screening operations, and 
#    storage 
#since the dust emissions from these activities are assumed to be well controlled."

#since I have documentable emissions from transfer/conveyors/crushing/screening/storage, I included them in this SCC.
pt_sccs <- c(
  30300001, 30300003, 30300307, 30300309, 30300310, 30300311, 30300312, 30300316, 30300318,
  30300336, 30300609, 30300610, 30300613, 30300614, 30300615, 30300616, 30300623, 30300624,
  30301002, 30301004, 30301010, 30301012, 30301013, 30301015, 30301016, 30301018, 30301019,
  30301020, 30301021, 30301030, 30301032, 30301102, 30301302, 30302301, 30302302, 30302303,
  30302304, 30302305, 30302306, 30302307, 30302316, 30302320, 30302325, 30302327, 30302328,
  30302330, 30302331, 30302341, 30302344, 30302345, 30302347, 30302393, 30302395, 30302396,
  30302397, 30302398, 30302401, 30302402, 30302403, 30302405, 30302406, 30302407, 30302409,
  30302410, 30303009, 30303014, 30303020, 30303026, 30303101, 30303102, 30303103, 30303104,
  30303105, 30303106, 30303107, 30304010, 30400108, 30400116, 30400117, 30400132, 30400357,
  30400358, 30400403, 30400411, 30400421, 30400422, 30400524, 30400612, 30400723, 30400724,
  30400736, 30400770, 30400775, 30400785, 30400812, 30401002, 30500115, 30500120, 30500121,
  30500134, 30500135, 30500141, 30500143, 30500144, 30500145, 30500302, 30500303, 30500305,
  30500355, 30500405, 30500406, 30500502, 30500609, 30500610, 30500611, 30500612, 30500616,
  30500624, 30500625, 30500626, 30500627, 30500628, 30500629, 30500709, 30500710, 30500711,
  30500712, 30500716, 30500727, 30500728, 30500729, 30500802, 30500803, 30500804, 30500806,
  30500904, 30500905, 30500906, 30500907, 30500908, 30500910, 30501006, 30501009, 30501010,
  30501011, 30501012, 30501014, 30501017, 30501022, 30501033, 30501034, 30501035, 30501036,
  30501037, 30501042, 30501043, 30501045, 30501048, 30501051, 30501060, 30501061, 30501062,
  30501104, 30501105, 30501106, 30501107, 30501114, 30501115, 30501117, 30501121, 30501122,
  30501123, 30501124, 30501221, 30501222, 30501224, 30501315, 30501316, 30501413, 30501502,
  30501504, 30501505, 30501506, 30501507, 30501509, 30501510, 30501513, 30501514, 30501515,
  30501518, 30501601, 30501602, 30501607, 30501610, 30501615, 30501616, 30501624, 30501625,
  30501629, 30501630, 30501631, 30501632, 30501710, 30501903, 30501904, 30501907, 30502001,
  30502002, 30502003, 30502004, 30502005, 30502006, 30502007, 30502009, 30502010, 30502014,
  30502015, 30502016, 30502017, 30502018, 30502021, 30502032, 30502104, 30502105, 30502106,
  30502502, 30502503, 30502507, 30502510, 30502511, 30502512, 30502514, 30502522, 30502523,
  30502701, 30502705, 30502713, 30502740, 30502760, 30503101, 30503102, 30503105, 30503106,
  30503108, 30503201, 30503202, 30503203, 30503204, 30503205, 30503206, 30503299, 30503312,
  30503331, 30503336, 30503341, 30503401, 30503501, 30503502, 30503503, 30503504, 30503506,
  30503813, 30504001, 30504002, 30504021, 30504022, 30504024, 30504030, 30504031, 30504034,
  30504102, 30504103, 30504115, 30504129, 30504151, 30504170, 30504171, 30504202, 30504203,
  30504215, 30504270, 30504271, 30504302, 30504303, 30504315, 30504329, 30504351, 30504370,
  30504371, 30504402, 30504403, 30504415, 30504451, 30504470, 30504471, 30504502, 30504503,
  30504515, 30504551, 30504570, 30504571, 30504602, 30504603, 30504615, 30504629, 30504670,
  30504671, 30505005, 30508906, 30508908, 30508911, 30508912, 30508914, 30508917, 30508949,
  30508958, 30508985, 30509002, 30509201, 30509205, 30510101, 30510102, 30510103, 30510104,
  30510105, 30510106, 30510107, 30510108, 30510196, 30510197, 30510198, 30510199, 30510201,
  30510202, 30510203, 30510204, 30510205, 30510206, 30510207, 30510208, 30510209, 30510296,
  30510297, 30510298, 30510299, 30510604, 30510808, 30510809, 30515003)

real_table <- pull_pt_removal_table(pt_sccs,scc) %>% 
  filter(is_point == FALSE) %>% 
  select(-is_point) %>%
  #only take PM emissions from the pull. Only do PMXX-PRI, because we assume that PM-CON is 0 and that PMXX-FIL=PMXX-PRI. For this SCC, we only are looking for dust, so we only look for PM
  filter(pollutant %in% c("PM10-PRI", "PM25-PRI"))

#There are counties with 0 emissions for this SCC. Since EPA offers default data for this SCC, if we don't explicitly put a "0" for those counties, EPA may add their default data in those counties. So we need to add "0"s for those counties.
pollutants <- c("PM10-PRI","PM25-PRI")
TPPPY <-c(0, 0)
efs_table <- make_simple_efs_table(scc,pollutants,TPPPY)
zeros_table <- make_baseline(efs_table,projection_tables[["Steady"]])
zeros_table$year <- as.integer(zeros_table$year)

#now combine the zeros data with the real data we have pulled
temp_table <- left_join(zeros_table, real_table, by=c("FIPS","SCC","year","pollutant"))
#reformat the real data NA's to be zeros, or else we will get errors when we add the columns
temp_table$TPY.y <- ifelse(is.na(temp_table$TPY.y),0,temp_table$TPY.y)
#add the columns and delete old fluff
temp_table$TPY <- temp_table$TPY.x + temp_table$TPY.y
temp_table <- temp_table %>% select(-c(TPY.x, TPY.y))

#let's just project this to remain steady. Am open to other options
temp_table <- project_baseline(temp_table, projection_tables[["Steady"]])

#no controls
final_table <- rbind(final_table,temp_table)


#                               manually calculate

# misc > ag crop harvesting
# we came up with emissions calculations for this SCC by ourselves. EPA does not offer any methodologies for it. Wheat, Corn, Hay, and Barley are like 99.3% of the particulate matter from harvesting in our state.
# The emission factors and calculation method is from chapter 10, Agricultural Harvesting of the "WRAP Fugitive Dust Handbook," dated September 7, 2006.									
# Acres harvested is from the US agricultural census for 2017.

scc <- 2801000005
pollutants <- c('PM10-PRI','PM25-PRI','PM10-FIL','PM25-FIL')
#given in lb of dust per acre harvested. PM25 is assumed to be 15% of PM10
TPPPY <-c(1.68/2000, 1.68/2000*0.15, 1.68/2000, 1.68/2000*0.15)
efs_table <- make_simple_efs_table(scc,pollutants,TPPPY)
#projection table contains acres harvested of the given agricultural product
hay_table <- make_baseline(efs_table,projection_tables[["Hay"]], project_to = end_year)

pollutants <- c('PM10-PRI','PM25-PRI','PM10-FIL','PM25-FIL')
#given in lb of dust per acre harvested. PM25 is assumed to be 15% of PM10
TPPPY <-c(5.8/2000, 5.8/2000*0.15, 5.8/2000, 5.8/2000*0.15)
efs_table <- make_simple_efs_table(scc,pollutants,TPPPY)
#projection table contains acres harvested of the given agricultural product
wheat_table <- make_baseline(efs_table,projection_tables[["Wheat"]], project_to = end_year)

pollutants <- c('PM10-PRI','PM25-PRI','PM10-FIL','PM25-FIL')
#given in lb of dust per acre harvested. PM25 is assumed to be 15% of PM10
TPPPY <-c(1.70/2000, 1.70/2000*0.15, 1.70/2000, 1.70/2000*0.15)
efs_table <- make_simple_efs_table(scc,pollutants,TPPPY)
#projection table contains acres harvested of the given agricultural product
corn_table <- make_baseline(efs_table,projection_tables[["Corn"]], project_to = end_year)

pollutants <- c('PM10-PRI','PM25-PRI','PM10-FIL','PM25-FIL')
#given in lb of dust per acre harvested. PM25 is assumed to be 15% of PM10
TPPPY <-c(5.8/2000, 5.8/2000*0.15, 5.8/2000, 5.8/2000*0.15)
efs_table <- make_simple_efs_table(scc,pollutants,TPPPY)
#projection table contains acres harvested of the given agricultural product
barley_table <- make_baseline(efs_table,projection_tables[["Barley"]], project_to = end_year)

#declare temp table as hay table, arbitrarily, to get the table with the right format
temp_table <- hay_table
#add together the 4 crops that produce dust when harvested.
temp_table$TPY <- hay_table$TPY + wheat_table$TPY + corn_table$TPY + barley_table$TPY

final_table <- rbind(final_table,temp_table)
rm(hay_table, wheat_table, corn_table, barley_table, temp_table, TPPPY, efs_table, pollutants, scc)


#1) Emission factors are from EPA's "Emission Inventory Improvement Program (EIIP)," Vol. III, (6/21/99 ed), section "Area Source Category Method Abstract - Bakeries."										
#2) Product Consumption factor is from EIIP, Vol. III, (6/21/99 ed), section "Area Source Category Method Abstract - Bakeries."										
#3) (I AM CURRENTLY NOT DOING THIS FILTERING STEP) Bakeries that distribute outside of Utah are disregarded in the double counting process (i.e. Interstate Brands and Pepperidge Farms).
#4) An EPA memo (that is cited in the EIIP document) suggests using the lower value of the range for sponge-dough emissions; i.e., 5.0 lbs VOC/1000 lbs product.										
#5) The "Estimated Consumption Fractions" were adjusted to 25% and 75% to achieve the 5.0 value suggest by that EPA memo.										
#bakeries, yeast
# Straight dough is 0.5 lb VOC/1000 lb product. 25% of product
# Sponge dough is 6.5 lb VOC/1000 lb, 75% of product
# 0.5(0.25) + 6.5(0.75) = 
#   5 lb VOC/1000 lb mixed product
# assume 70 lb of bread per person per year
# 
# Population * 70 lb/person * 1 klb/1000 lb * 5 lb VOC/ klb * 1 TPY/2000lb 
#   Population * 70/1000*5/2000
#   Population * 350/2,000,000
#     Population * 1.75E-4 = TPY VOC
scc <- 2302050000
pollutants <- c('VOC')
TPPPY <-(1.75E-4)
efs_table <- make_simple_efs_table(scc,pollutants,TPPPY)
temp_table <- make_baseline(efs_table,projection_tables[["Population"]], project_to = end_year)
#every SCC with 302032XX. Manually inputting this one
pt_sccs <- seq.int(30203201,30203299)
pt_pols <- c('VOC')
pt_table <- pull_pt_removal_table(pt_sccs,scc,raw_scc_pull_return = FALSE)
#pt_table <- pull_pt_removal_table(pt_sccs,pt_pols,scc,raw_scc_pull_return = TRUE)
pt_table <- project_baseline(pt_table,projection_tables[["Population"]],has_pt = TRUE)
temp_table <- subtract_pt_sources(pt_table,temp_table)
#no controls
final_table <- rbind(final_table, temp_table)


#percent of households that own pets is from American Veterinary Medical 
#  Association 2018 report. (main_workbook/references/2806XXXXXX)
#  24.7% of households own cats in Utah
#
#googled people per household in utah, ballpark is sufficient, but got from Kem Gardner
#  people/household for utah
#  https://gardner.utah.edu/wp-content/uploads/UtahAtAGlance_20180207.pdf
#  3.19 people/household
#
#The emission factor is from, "Development of an Updated Gridded Ammonia Emission Inventory for the South Coast Air Basin."
#  0.348 lb/cat/year
#
#ammonia, domestic cats
#based on, and projects with population
#  3.19 people/house
#  24.7% of houses own cats
#  0.348 lb/cat/year = 1.74 E-4 T/cat/year
#    population * 1 house/3.19 population * 0.247 cat/house * 1.74E-4Ton/cat/year
#    1/3.19*.247*1.74E-4
# 1.35E-5 TPPPY
scc <- 2806010000
pollutants <- c('NH3')
TPPPY <-(1.35E-5)
efs_table <- make_simple_efs_table(scc,pollutants,TPPPY)
temp_table <- make_baseline(efs_table,projection_tables[["Population"]],project_to = end_year)
#no pt source
#no controls
final_table <- rbind(final_table, temp_table)

#percent of households that own pets is from American Veterinary Medical 
#  Association 2018 report. (main_workbook/references/2806XXXXXX)
#  36.2% of households own dogs in Utah
#
#googled people per household in utah, ballpark is sufficient, but got from Kem Gardner
#  people/household for utah
#  https://gardner.utah.edu/wp-content/uploads/UtahAtAGlance_20180207.pdf
#  3.19 people/household
#
#The emission factor is from, "Development of an Updated Gridded Ammonia Emission Inventory for the South Coast Air Basin."
#  2.17 lb/dog/year
#
#based on, and projects with population
#  3.19 people/house
#  36.2% of houses own cats
#  2.17 lb/dog/year = 1.085E-3 T/dog/year
#    population * 1 house/3.19 population * 0.362 dog/house * 1.085E-3Ton/dog/year
#    1/3.19*.362*1.085E-3
# 1.23E-4 TPPPY
scc <- 2806015000
pollutants <- c('NH3')
TPPPY <-(1.23E-4)
efs_table <- make_simple_efs_table(scc,pollutants,TPPPY)
temp_table <- make_baseline(efs_table,projection_tables[["Population"]],project_to = end_year)
#no pt source
#no controls
final_table <- rbind(final_table, temp_table)

#human perspiration, respiration, cigarette smoking
#all ammonia
#confusing. SAYS this is no longer reported due to lack of documentation,
#but it IS reported. It also says to contact Maine. So I did... We will see. Maine could not help haha.
#1) Emission factors from SCAQS, appendix G, pages G2 through G-3.
#2) SCAQS is an abbreviation for the document entitled "Development of the Ammonia Emission Inventory for the Southern California Air Quality Study."
#3) That document was prepared by the Radian Corporation, September 1991.
#4) Human Perspiration is estimated at 0.55 lbs ammonia per person per year.
#5) Human Respiration is estimated at 0.0035 lbs ammonia per person per year.
#6) Cigarette smoking is estimated at 0.022 lbs ammonia per person per year.
#7) Sum of the above 3 factors is 0.5755 lbs ammonia per person per year.
#2.88E-4 TPPPY
scc <- 2810010000
pollutants <- c('NH3')
TPPPY <-(2.88E-4)
efs_table <- make_simple_efs_table(scc,pollutants,TPPPY)
temp_table <- make_baseline(efs_table,projection_tables[["Population"]],project_to = end_year)
#no pt subtraction
#no controls
final_table <- rbind(final_table, temp_table)

#structure fires
#1) Guidance used is from the "Emission Inventory Improvement Program (EIIP)," Vol. III, (1/31/01 ed.), Chapter 18, "Structure Fires."
#2) Emission factors are from EIIP, Vol. III, Chapter 18, "Structure Fires," (1/31/01 ed.), Table 18.4-1.
#3) Calculations include fires in buildings and other fixed structures of all types.
#4) Fires are indexed to human population; counties with more people equates to more fires.
#5) HAPs emission factors are from "Documentation for the 1999 Base Year Nonpoint Area Source National Emission Inventory for Hazardous Air Pollutants."
#6) Seasonal activity factors are from EPA's Emissions Inventory Improvement Plan Table 1.4-3.

#2.3 fires/1000 people
#1.2 tons burned per fire
#  so 2.76 tons burned per 1000 people
#  0.00276 tons per person
#
#VOC 11 lb/ton burned
#  1.52E-5 TPPPY
#PM (10 and 2.5) 10.8 lb/ton
#  1.49E-5 TPPPY
#CO 60 lb/ton
#  8.28E-5 TPPPY
#NOx 1.4 lb/ton
#  1.93E-6 TPPPY
#Acrolein (107028) 4.414 lb/ton
#  6.09E-6 TPPPY
#Hydrogen Cyanide (74908) 35.486 lb/ton
#  4.90E-5 TPPPY
#Hydrogen Chloride (7647010) 15.112 lb/ton
#  2.09E-5 TPPPY
#Formaldehyde (50000) 1.023 lb/ton
#  1.41E-6 TPPPY
scc <- 2810030000
pollutants <- c('VOC','PM10','PM25','CO','NOX','107028','74908','7647010','50000')
TPPPY <-c(1.52E-5,1.49E-5,1.49E-5,8.28E-5,1.93E-6,6.09E-6,4.90E-5,2.09E-5,1.41E-6)
efs_table <- make_simple_efs_table(scc,pollutants,TPPPY)
temp_table <- make_baseline(efs_table,projection_tables[["Population"]],project_to = end_year)
#no pt subtract
#no controls
final_table <- rbind(final_table, temp_table)

#vehicle fires
#1) EPA's "Emission Inventory Improvement Program (EIIP)," Volume III, "Area Sources Category Method Abstract - Vehicle Fires," (5/15/00 edition) is used. Material burned is in the text on page 1.
#2) The EIIP gives emission factors for PM, CO, NOx, nonmethane total organic compounds, and methane.
#3) The "nonmethane total organic compounds" is assumed equal to VOC. Methane is ignored.
#5) Fires per 1000 people derived by averaging 2010-2013 summary & "by FDID" data on the Utah Fire Incident Reporting System, Utah Fire Marshal's Office at: https://site.utah.gov/publicsafety/firemarshal/nfirs.html. NOTE: To conform with EIIP methods, water, rail and aircraft vehicle fires were excluded, only fire codes 130-132, and 136-138 were summed each year.

#Vehicle Fire Data
#*Note in 2012, only summary data is available and water/rail/air fires could not be excluded.	
#Year	              2010 2011	2012*	2013						
#Incidents	        804  758  702	  646						
#Avg Yearly Fires   727.5						
#Per 1000 people		0.232903894						

#0.2329 fires/1000 ppl
#2.33E-4 fires/person
#0.25 Tons burned per car
#  5.825E-5 Tons burned per person

#PM (10 and 2.5) 100 lb/ton
#  2.91E-6 TPPPY
#NMOC (assumed to be VOC) 32 lb/ton
#  9.32E-7 TPPPY
#CO 125 lb/ton 
#  3.64E-6 TPPPY
#NOx 4 lb/ton
#  1.16E-7 TPPPY
scc <- 2810050000
pollutants <- c('PM10','PM25','VOC','CO','NOX')
TPPPY <- c(2.91E-6,2.91E-6,9.32E-7,3.64E-6,1.16E-7)
efs_table <- make_simple_efs_table(scc,pollutants,TPPPY)
temp_table <- make_baseline(efs_table,projection_tables[["Population"]],project_to = end_year)
#no pt subtract
#no controls
final_table <- rbind(final_table, temp_table)

#LUST - Leaking Underground Storage Tanks
#baseline based on number of remediation events in a given year from DERR
#projection based on average past 5 years
#1) Each remediation is estimated to release 28 lbs/day based on “Emission Inventory Improvement Program (EIIP),” Vol. III, “Area Source Category Method Abstract-Remediation of Leaking Underground Storage Tanks”	
#2) Each remediation is assumed to last a full 12 months.											
#3) Each remediation is assumed to occur in the year it began.											
#4) The number of remediation events was measured by DEQ-DERR, Sean Warner, 536-4163.	
#LUST table projects based on average of past years
scc <- 2660000000
#pull all years because of how the projection is calculated
pollutants <- c('VOC')
TPUPY <-(5.11)
efs_table <- make_simple_efs_table(scc,pollutants,TPUPY)
#LUST is pulled from base_inputs. It has all the leaking underground storage tanks in the state
temp_table <- make_baseline(efs_table,projection_tables[["LUST"]],project_to = end_year)
#no controls?
#no pt subs?
final_table <- rbind(final_table, temp_table)


#solvent use - fuel tank/drum cleaning
#used to be 2461160000, but in 2016, was mapped to 2461100000 (see 'sccref' source)
#Uses AP42 4.8 for tank truck cleaning. Largest EF in the document 
#  is 0.686 lb/truck, so that's what we used. (4.8-2)
#Federal Highway Administration Department of Motor Carriers, Bruce Holmes, 
#  estimated that 400 cargo tanks are cleaned and purged annually in Salt Lake
#  and Davis Counties. (No date given or citation on this number)
#So 400 tanks with a population of 1,127,117 and 348,281, respectively, is
#  400 tank cleanings/1,475,398 people, or:
#    2.711E-4 tank cleanings/person.
#with 0.686 lb/cleaning, we have 
#    2.711E-4 * 0.686 / 2000 = 
#    9.299E-8 Ton/person/year
#We then extrapolate that to the rest of the state
scc <- 2461100000
pollutants <- c('VOC')
TPPPY <-(9.299E-8)
efs_table <- make_simple_efs_table(scc,pollutants,TPPPY)
temp_table_project <- make_baseline(efs_table,projection_tables[["Population"]],project_to = end_year)
#no pt source
#assumed rule 307-304 for solvent cleaning applies to this SCC.
# ends up with 28% reduction over 2017-2022
# we need to input a current_efs table to the controls function since these emission factors don't exist in the Wagon Wheel.
tank_efs <- efs_table %>%
  mutate(EmissionsFactor = TPUPY*2000,
         EFNumerator = "LB") %>%
  rename(FIPS = county) %>%
  select(-TPUPY)

# now run the function. we supplied all the needed emissions factors for adding controls in the current_efs table. we'll just set use_ww = FALSE anyway since this SCC doesn't exist in the WW.
temp_table_controlled <- add_controls(temp_table_project, current_efs = tank_efs, use_ww = FALSE)
final_table <- rbind(final_table, temp_table_controlled)

# remove the objects we created from the environment
rm(scc, pollutants, TPPPY, efs_table, temp_table_project, tank_efs, temp_table_controlled)
```


NOTE: We always do pt source subtractions AFTER adding controls to the emissions estimates. We assume that our pt source emissions are already using the controls before they get phased in.

```{r solvents (24-xx-xxx-xxx)}
# Solvent Utilization > Surface Coating > Traffic Markings > Total: All Solvent Types
# INCOMPLETE - WE DO NOT HAVE 2017 UDOT DATA. 
# TO DO FOR 2020 NEI - GET 2020 LANE MILES DATA FROM UDOT
## Another thing to consider is creating a lane miles projection, instead of using a population projection, because lane miles do not scale proportionally with population.

## We do not have 2017 lane miles data from UDOT; the data that was used in the workbook (Input Table 102: Paved Roads (lane miles of pavement)) is inaccurate (it was just the length of paved roads in Utah, not total lane miles; to get lane miles, we need to multiply road segment length (paved and unpaved roads) by number of through lanes, but we don't have a through lanes column or the length of unpaved roads in the data we got from UDOT for the excel workbook)
### Workbook lane miles are the total length of paved roads - input table gives 24,036 total "lane miles" in Utah in 2017; EPA lane miles are from FHWA state-level data, giving 104,219.6 lane miles in Utah in 2017
# https://www.fhwa.dot.gov/policyinformation/statistics/2017/hm60.cfm
### this results in the estimated emissions for VOCs from traffic markings being 5x lower in our workbook than in the WW
# Total 'lane miles' (as defined by UDOT and FHWA) includes all the lanes in every county (road length * number of lanes), including paved and unpaved roads
# Casey Trout contacted UDOT on Feb 9, 2021 to inquire about updated lane miles data; Austin Baysinger (abaysinger@utah.gov, 801-965-4846) responded to her inquiry and sent lane miles data for 2019; the excel file Austin sent has a tab for paved and unpaved roads, each row includes the total length of a road as well as the "through lanes" (the number of lanes on each of those road segments); lane miles is calculated by multiplying the length of the road segment by the through lanes. This resulted in calculating 102,030.4 total lane miles in Utah in 2019 (very similar to the FHWA estimate for Utah for 2017). However, Casey was unable to obtain 2017 & 2018 lane miles data, as UDOT transferred to a new data system and no longer had that data.
# EPA's NEMO method for calculating the through lanes in counties involved apportioning the total through lanes in the entire state (i.e. 102,030.4 in 2019) using the population in each county; this resulted in drastically overestimating the number of through lanes in more populous counties - i.e., in Salt Lake County, EPA estimated ~38000 lane miles, whereas the 2019 UDOT data identifies ~9000 lane miles; it is worth using UDOT data because it is more accurate than apportioning lane miles by population. My understanding is that UDOT reports total lane miles in the state to the FHWA; so EPA uses the FHWA data for total lane miles in each state & apportions back to counties using population, but UDOT has the ACTUAL numbers of lane miles in counties. (Therefore, using the actual number of lane miles in each county (UDOT data) to calculate emissions from traffic markings is more accurate than using the estimated number of lane miles by apportioning the Utah total lane miles to counties based on population).

# Since we do not have 2017 lane miles data, we will use the WW for the 2017 emissions inventory, as at least the throughput and EF are synced up.
scc <- 2401008000
temp_table <- pull_baseline_from_ww(scc)
#projects with population
temp_table <- project_baseline(temp_table, projection_tables[["Population"]])
#no controls, no pt subs
final_table <- rbind(final_table,temp_table)


# Solvent Utilization > Surface Coating > Auto Refinishing: SIC 7532 > Total: All Solvent 
# We assume that businesses within each county fill the autobody refinishing needs of their own county; while this may not be absolutely accurate, any error will cancel between adjacent counties.
scc <- 2401005000

## WW uses autobody refinishing employees (NAICS 4411, 4412, 81112) for the throughput
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["Population"]])

# add controls
## R307-354 Autobody Refinishing
## Assume 5-year phase-in period starting in 2016 based on UCAIR grant program initiation to support the industry; 73% reduction
## Controls apply to NAA counties
temp_table_controlled <- add_controls(temp_table_project)

temp_table_final <- temp_table_controlled

# add to final table
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_controlled, temp_table_final)


# Solvent Utilization > Surface Coating > Factory Finished Wood: SIC 2426 thru 242 > Total: All Solvent Types
scc <- 2401015000
# Make baseline - WW uses NAICS 321 employees for the throughput
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])
# Apply controls
## R307-349 Flat Wood Surface Coating
## Assume 5-yr phase in period starting in 2018; 30% reduction from the 2014 EF of 48 lbs/employee
## NAA Counties only
temp_table_controlled <- add_controls(temp_table_project)

# Pt source subtractions
## EPA crosswalk lists a lot of potential point to nonpoint, and then project it
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc) 
pt_subs <- project_baseline(base_table = pt_subs, projection_table = projection_tables[["ManEmp"]], has_pt = TRUE)

# Subtract uncontrolled point source emissions from our temp_table
temp_table_final <- subtract_pt_sources(base_emission_table = temp_table_controlled, pt_source_table = pt_subs)

# add to final table
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_controlled, pt_sccs, pt_subs, temp_table_final)


# Solvent Utilization > Surface Coating > Wood Furniture: SIC 25 > Total: All Solvent Types
## Note: The EF listed in the Workbook is from the 2014 NEI and is 437 lbs/employee; the new WW EF is 282.87 lbs/employee. The EF decreased from the 2014-2017 NEI. This implies that the controls may no longer be relevant.
# Get total emissions from ww, project based on manufacturing employment, apply controls, pt source subtractions using pull_pt_removal_table.
scc <- 2401020000

# Throughput is employees in NAICS 337110, 337121, 337122, 337127*, 337211, 337212, 337215*
# *Employment data is split equally between wood furniture and metal furniture source categories
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# Apply controls
## R307-343 Wood Furniture Manufacturing
## Assume 5-yr phase in period starting in 2018; 74% reduction
## "Training program, in collaboration with manufacturers, on new coating application began in 2016 when distributors began to see source purchases of compliant coatings."
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project)

# Pt source subtractions
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc) 
pt_subs <- project_baseline(base_table = pt_subs, projection_table = projection_tables[["ManEmp"]], has_pt = TRUE)
temp_table_final <- subtract_pt_sources(base_emission_table = temp_table_controlled, pt_source_table = pt_subs)

# add to final table
final_table <- rbind(final_table, temp_table_final)
rm(scc, temp_table, temp_table_project, temp_table_controlled, pt_sccs, pt_subs, temp_table_final)


# Solvent Utilization > Surface Coating > Metal Furniture: SIC 25 > Total: All Solvent Types
scc <- 2401025000
# Throughput is employees in NAICS 337124, 337127*, 337214, 337215*
# *Employment data is split equally between wood furniture and metal furniture source categories
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# Apply controls
## R307-346 Metal Furniture Surface Coating
## Assume 5-yr phase in period starting in 2018; 27% reduction
## NAA counties
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project)

# Pt source subtractions
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc) # No pt subtractions from crosswalk.
#the code will break if we try to project a blank table, so I will not project it, but if the table
#is ever not blank, throw up a message
if(dim(pt_subs)[1]!=0){
  cat('update pt subs code for 2401025000\n')
}
#pt_subs <- project_baseline(base_table = pt_subs, projection_table = ManEmp, has_pt = TRUE)
#temp_table_final <- subtract_pt_sources(base_emission_table = temp_table_controlled, pt_source_table = pt_subs)

temp_table_final <- temp_table_controlled
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_controlled, pt_sccs, pt_subs, temp_table_final)


# Solvent Utilization > Surface Coating > Paper: SIC 26 > Total: All Solvent Types
scc <- 2401030000
# Throughput is employees in NAICS 322220
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# Apply controls
## R307-344 Paper, Film and Foil Surface Coating
## Assume 5-yr phase in period starting in 2018; 71% reduction
## NAA counties
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project)

# Pt source subtractions
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc) 
pt_subs <- project_baseline(base_table = pt_subs, projection_table = projection_tables[["ManEmp"]], has_pt = TRUE)
temp_table_final <- subtract_pt_sources(base_emission_table = temp_table_controlled, pt_source_table = pt_subs)

# add to final table
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_controlled, test, pt_sccs, pt_subs, temp_table_final)


# Solvent Utilization > Surface Coating > Metal Cans: SIC 341 > Total: All Solvent Types
scc <- 2401040000
# Throughput is employees in NAICS 33243
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# Apply controls
## R307-352 Sheet, Strip, Coil and Container Surface Coating
## Assume 5-yr phase in period starting in 2018; 33% reduction
## NAA counties
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project)

# Pt source subtractions
## EPA crosswalk lists a lot of potential related point sccs
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc)
pt_subs <- project_baseline(base_table = pt_subs, projection_table = projection_tables[["ManEmp"]], has_pt = TRUE)
temp_table_final <- subtract_pt_sources(base_emission_table = temp_table_controlled, pt_source_table = pt_subs)

# add to final table
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_controlled, pt_sccs, pt_subs, temp_table_final)


# Solvent Utilization > Surface Coating > Machinery and Equipment: SIC 35 > Total: All Solvent Types
## Note: The EF listed in the Workbook is from the 2014 NEI and is 44 lbs/employee; the new WW EF is 34.28 lbs/employee. The EF decreased from the 2014-2017 NEI. This implies that the controls may no longer be relevant.
scc <- 2401055000
# Throughput is employees in NAICS 3331, 3332, 3333, 33341
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# Apply controls
## R307-350 Miscellaneous Metal Surface Coating
## NAA Counties only
## Assume 5-yr phase in period starting in 2018; 31% reduction
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project)

# Pt source subtractions
## EPA crosswalk lists a lot of potential related point sccs
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc)
pt_subs <- project_baseline(base_table = pt_subs, projection_table = projection_tables[["ManEmp"]], has_pt = TRUE)
temp_table_final <- subtract_pt_sources(base_emission_table = temp_table_controlled, pt_source_table = pt_subs)

# add to final table
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_controlled, pt_sccs, pt_subs, temp_table_final)

# Solvent Utilization > Surface Coating > Large Appliances: SIC 363 > Total: All Solvent Types
# DONE

# Get ww emissions estimates; apply controls; there are no pt source subtractions.
scc <- 2401060000
# Throughput is employees in NAICS 3352
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# Apply controls
## R307-347 Large Appliance Surface Coating
## NAA Counties only
## Assume 5-yr phase in period starting in 2018; 24% reduction
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project)

# Pt source subtractions
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
## there are not any counties with pt subs
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc)
#the code will break if we try to project a blank table, so I will not project it, but if the table
#is ever not blank, throw up a message
if(dim(pt_subs)[1]!=0){
  cat('update pt subs code for 2401060000\n')
}
#project pt subs in that case, probs with ManEmp

temp_table_final <- temp_table_controlled
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_controlled, pt_sccs, pt_subs, temp_table_final)


# Solvent Utilization > Surface Coating > Electronic and Other Electrical: SIC 36 - 363 > Total: All Solvent Types
## Note: The EF listed in the Workbook is from the 2014 NEI and is 30 lbs/employee; the new WW EF is 15.58 lbs/employee. The EF decreased from the 2014-2017 NEI. This implies that the controls may no longer be relevant.
scc <- 2401065000
# Throughput is employees in NAICS 331318, 331420, 331491, 335921, 335929, 335311
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# Apply controls
## R307-348
## NAA Counties
## Starts in 2018; 28% reduction
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project)

# Pt source subtractions
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
# there are no pt source subtractions
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc) 
#the code will break if we try to project a blank table, so I will not project it, but if the table
#is ever not blank, throw up a message
if(dim(pt_subs)[1]!=0){
  cat('update pt subs code for 2401065000\n')
}
#project pt subs in that case, probs with ManEmp

temp_table_final <- temp_table_controlled
# add to final table
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_controlled, pt_sccs, pt_subs, temp_table_final)


# Solvent Utilization > Surface Coating > Motor Vehicles: SIC 371 > Total: All Solvent Types
scc <- 2401070000
# Throughput is employees in NAICS 3361, 3362, 3363
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# Apply controls
## R307-350
## NAA Counties
## Assume 5-year phase-in period starting in 2018 based on industry input; 31% reduction
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project)

# Pt source subtractions
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc) 
pt_subs <- project_baseline(base_table = pt_subs, projection_table = projection_tables[["ManEmp"]], has_pt = TRUE)
temp_table_final <- subtract_pt_sources(base_emission_table = temp_table_controlled, pt_source_table = pt_subs)

# add to final table
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_controlled, pt_sccs, pt_subs, temp_table_final)

# Solvent Utilization > Surface Coating > Aircraft: SIC 372 > Total: All Solvent Types
scc <- 2401075000
# Throughput is employees in NAICS 3364
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# Apply controls
## R307-350 Miscellaneous Metal Surface Coating
## NAA Counties 
## Assume 5-year phase-in period starting in 2018 based on major source inspection; 46% reduction
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project)

# Pt source subtractions
## EPA crosswalk lists 7 potential related point sccs
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
## there are no pt subtractions
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc) 
#the code will break if we try to project a blank table, so I will not project it, but if the table
#is ever not blank, throw up a message
if(dim(pt_subs)[1]!=0){
  cat('update pt subs code for 2401075000\n')
}
#project pt subs in that case, probs with ManEmp

temp_table_final <- temp_table_controlled
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_controlled, pt_sccs, pt_subs, temp_table_final)


# Solvent Utilization > Surface Coating > Marine: SIC 373 > Total: All Solvent Types
scc <- 2401080000
# Throughput is employees in NAICS 3366, 488390
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# No controls

# EPA crosswalk lists 7 potential related point sccs
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
# there are no pt subtractions
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc) 
#the code will break if we try to project a blank table, so I will not project it, but if the table
#is ever not blank, throw up a message
if(dim(pt_subs)[1]!=0){
  cat('update pt subs code for 2401080000\n')
}
#project pt subs in that case, probs with ManEmp

temp_table_final <- temp_table_project
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, pt_sccs, pt_subs, temp_table_final)


# Solvent Utilization > Surface Coating > Railroad: SIC 374 > Total: All Solvent Types
scc <- 2401085000
# Throughput is employees in NAICS 3365
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# No controls
# Pt source subtractions
## No pt sccs
#pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)

temp_table_final <- temp_table_project
# add to final table
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_final)


# Solvent Utilization > Surface Coating > Miscellaneous Manufacturing > Total: All Solvent Types
scc <- 2401090000
# Throughput is employees in NAICS 339, 3369
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# Apply controls
## Apply to NAA Counties
## Two applicable rules based on the two NAICS employment categories used for the throughput (3369// and 339//)
## Greg Mortensen (previous Area Source Inventory Environmental Scientist) and Joel Karmazyn (Rule making) worked together to allocate NAICS codes under 3369// and 339// to plastic parts surface coating and fabric/vinyl coating by researching the NAICS codes. We still use the NAICS allocations they created. There is room for improvement in this scc; a rule that encompassed the entirety of the NAICS codes under this scc (instead of two rules that apply to different industries that both fall under this scc) would be more accurate. We may want to revisit these rules in the future.

### R307-353 Plastic Parts Surface Coating
### The following NAICS were considered for the plastic coating employment subset: 336991, 336992, 336999, 339113, 339910, 339920, 339930, 339940, 339950, 339992.
### Based on 2017 Census Utah employment data by NAICS, the employment for plastic coatings represents approximately 38.9% of employment related to this scc. The control is therefore only applied to 38.9% the total emissions.
### Assume 5 yr phase-in period starting in 2018 based on industry input
### The control is expected to reduce applicable VOC emissions by 27% for all NAA counties.
### R307-345 Fabric and Vinyl Surface Coating
### We assume that fabric and vinyl account for the remaining 61.1% of employment for this scc. 
### Assume 5-year phase-in period starting in 2018 based on industry input; 47% reduction
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project)

# Pt source subtractions
## EPA crosswalk lists a lot of potential related point sccs
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc) 
pt_subs <- project_baseline(base_table = pt_subs, projection_table = projection_tables[["ManEmp"]], has_pt = TRUE)
temp_table_final <- subtract_pt_sources(base_emission_table = temp_table_controlled, pt_source_table = pt_subs)

# add to final table
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_controlled, pt_sccs, pt_subs, temp_table_final)


# Solvent Utilization > Surface Coating > Industrial Maintenance Coatings > Total: All Solvent Types
scc <- 2401100000
# Throughput is population
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["Population"]])

# No controls

# Pt source subtractions
## No potential related point sccs in the crosswalk
#pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
temp_table_final <- temp_table_project
# add to final table
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_final)


# Solvent Utilization > Surface coating > Other Special Purpose Coatings > Total: All Solvent Types
# Pull baseline emissions from WW, project based on population, add controls, no pt source subtractions.
scc <- 2401200000
# Throughput is population
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["Population"]])

# Apply controls
## NAA counties
## R307-350 Miscellaneous Metal Surface Coating
## Assume 5-year phase-in period starting in 2018 based on major source inspection; 31% reduction
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project)

# Pt source subtractions
## No potential related point sccs in the crosswalk
#pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)

temp_table_final <- temp_table_controlled
final_table <- rbind(final_table, temp_table_final)
rm(scc, temp_table, temp_table_project, temp_table_controlled, temp_table_final)


# Solvent Utilization > Degreasing > All Processes/All Industries > Total: All Solvent Types
# Pull baseline from WW, project based on manufacturing employment growth, add controls, point source subtractions.
scc <- 2415000000
# Throughput is employees in NAICS codes 331, 332, 333, 334, 335, 336, 337, 339, 441, 483, 484, 485, 488, 8111, 8112
temp_table <- pull_baseline_from_ww(scc = scc)
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# Apply controls
## NAA Counties
## R307-304 Solvent Cleaning
## Assume 5-year phase-in period starting in 2018; 28% reduction
## Note: Workbook states "controls apply to residential only" - not sure what is meant by this.
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project)

# Pt source subtractions
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc) 
pt_subs <- project_baseline(base_table = pt_subs, projection_table = projection_tables[["ManEmp"]], has_pt = TRUE)
# Subtract uncontrolled point source emissions from our temp_table
temp_table_final <- subtract_pt_sources(base_emission_table = temp_table_controlled, pt_source_table = pt_subs)

# add to final table
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, temp_table_project, temp_table_controlled, pt_sccs, pt_subs, temp_table_final)


# Solvent Utilization > Dry Cleaning > All Processes > Total: All Solvent Types
# Workbook Note: On 3/7/12 - VOC Emission Factor was changed to 10 lb/employee as per ERTAC/UDAQ/Industry collaboration.
# We should really just use the emission factor from the WW for this one in the 2020 NEI. We are not justified in continuing to use the 10 lb/employee emission factor.
# Get baseline from WW; adjust total emissions to be reflective of what they would be if we were using the Utah EF; project based on population; apply controls to ALL counties in the scc for PERC only; pt source subtractions.
scc <- 2420000000

# EPA EF VOC: 20.4 lb/each
# Utah EF VOC: 10 lb/each
# EPA EF PERC (127184): 118.35 lb/each
# Utah EF PERC (tetrachloroethylene): use the WW EF for perc
# Throughput is employees in NAICS code 812320
# Pull baseline emissions from the WW
temp_table <- pull_baseline_from_ww(scc = scc)

# change total emissions to reflect what they would be if we were using the Utah EF for VOCs by multiplying TPY by Utah EF/WW EF
# this will be okay, unless we decide it is important to use a different throughput value, as they do in the workbook
## First, get the EFS for this SCC from the WW
## This will give us the EFs for every pollutant in every county associated with this SCC
ww_ef <- pull_efs_from_ww(scc = scc, throughput_unit = 'EACH', all_primaries = TRUE)
## Filter by pollutant = VOC, select only TPUPY column
ww_ef_VOC <- ww_ef %>% filter(pollutant == 'VOC') %>% select(TPUPY)
## get the first EF that shows up (they should all be the same), then multiply by 2000 because the EF is in tons, not lbs, but we need it in lbs since the EF we use (201 lbs/each) is in lbs
ww_ef_VOC <- ww_ef_VOC[[1,1]] * 2000

## now we can multiply the TPY column for all of the VOC values in the temp table by the new emission factor we're using divided by the ww emission factor 
## this will give us emissions using our EF, not the WW EF
temp_table$TPY <- ifelse(temp_table$pollutant == "VOC", temp_table$TPY*(10/ww_ef_VOC), temp_table$TPY)

temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["Population"]])

# Apply controls
## All counties in the scc are affected
## No applicable rule - 
### Workbook note: "On 3/18/2015, added in perc phase out factor to adjust perc emissions based on consultation with local industry representative (Brad Overmore, former president of Red Hanger) and DAQ Dry Cleaner Inspector, Greg Sorenson. Perc machine life expectancy was 15 years and hydrocarbon/green earth machines began to be used in Utah around 2011.
## Assume 15-year phase-in period starting in 2011; 100% reduction; only applies to 127184
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project)

# Pt source subtractions
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc) 
pt_subs <- project_baseline(base_table = pt_subs, projection_table = projection_tables[["Population"]], has_pt = TRUE)

# Subtract uncontrolled point source emissions from our temp_table
temp_table_final <- subtract_pt_sources(base_emission_table = temp_table_controlled, pt_source_table = pt_subs)
# add to final table
final_table <- rbind(final_table, temp_table_final)

# remove the objects we created for this scc
rm(scc, temp_table, ww_ef, ww_ef_VOC, temp_table_project, temp_table_controlled, pt_sccs, pt_subs, temp_table_final)


# Solvent Utilization > Graphic Arts > All Processes > Total: All Processes
# NOTE!! With the 2020 NEI, we need to use the emissions factor that EPA provides; we will no longer use our own emissions factor. EPA is updating the methodology to calculate emissions from graphic arts, and the emissions factor that we use is 10 years old, from an outdated survey UDAQ carried out. We can't justify using our outdated emissions factor once EPA revamps the calculation methods in 2020.
## Workbook Note: VOC emissions factor was changed to 201 lbs/employee on 3/7/2012 as a result of ERTAC/Utah/Industry collaboration. Old EF was 1482 lbs/employee. New EF accounts for advances made in low-VOC content inks and solvents now in use.
### Therefore, we use our own EF, not the WW one.
## Workbook Note: We assume that businesses within each county fill the graphic arts needs of their own county. (While this may not be absolutely accurate, any error will cancel between adjacent counties.)
## Workbook Note: Employee numbers from paper, foil, and film (SCC 2401030000) are deducted from graphic arts to avoid a double count due to NAICS overlap.
### Michael and I decided not to do this, because sccs should reflect a specific process that is emitting. EPA decided to include NAICS 322230 in this scc, as well as 2401030000, so we assume that this scc is accounting for a different process than the process in 2401030000 and we should not be subtracting the throughput from 2401030000 from the throughput for this SCC.
# Get baseline emissions from WW, pull EFs from WW, divide our Utah EF by the WW ef and multiply the TPY in baseline emissions to convert the total emissions to what they would be if we were using our EF, project based on manufacturing employment, add controls, find pt source subtractions, project pt source subtractions, subtract them, add to final table.
scc <- 2425000000
# EPA EF VOC: 1583.65 lb/each
# Utah EF VOC: 201 lb/each
# Throughput is employees in NAICS code 32311, 322211, 322212, 322219, 322220, 322230, 322291, 322299
# Pull baseline emissions from the WW
temp_table <- pull_baseline_from_ww(scc = scc)

# change total emissions to reflect what they would be if we were using the Utah EF by multiplying TPY by Utah EF/WW EF
# this will be okay, unless we decide it is important to use a different throughput value, as they do in the workbook
## First, get the EFS for this SCC from the WW
## This will give us the EFs for every pollutant in every county associated with this SCC
ww_ef <- pull_efs_from_ww(scc = scc, throughput_unit = 'EACH')
## Filter by pollutant = VOC, select only TPUPY column
## Only the VOC is given in ton/each; the others are given in ton/ton (secondaries are just a % of total VOC)
ww_ef <- ww_ef %>% filter(pollutant == 'VOC') %>% select(TPUPY)
## get the first EF that shows up (they should all be the same), then multiply by 2000 because the EF is in tons, not lbs, but we need it in lbs since the EF we use (201 lbs/each) is in lbs
ww_ef <- ww_ef[[1,1]] * 2000

## now we can multiply the TPY column in the temp table by the new emission factor we're using divided by the ww emission factor 
## we multiply every cell by the ratio of our EF/ww_ef  because the pollutants that are not VOC are all secondaries, so they will decrease proportionally with VOCs
## this will give us emissions using our EF, not the WW EF
temp_table$TPY <- temp_table$TPY*(201/ww_ef)

# project - UDAQ projects by manufacturing employment
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["ManEmp"]])

# Apply controls
## R307-351 Graphic Arts Surface Coating
## NAA Counties
## Assume 3 year phase-in starting in 2018; 61% reduction
## we need to create our own current_efs table since we use a different EF than what exists in the wagon wheel
graphic_arts_efs <- data.frame(FIPS = unique(temp_table$FIPS), SCC = scc, pollutant = "VOC", EmissionsFactor = 201, EFNumerator = "lb")

# now add controls. we add use_ww = FALSE here, even though we provide all the efs that will be used.
temp_table_controlled <- add_controls(raw_proj_data = temp_table_project, current_efs = graphic_arts_efs, use_ww = FALSE)

# Pt source subtractions
pt_sccs <- pull_pt_scc_crosswalk(area_scc = scc)
pt_subs <- pull_pt_removal_table(pt_sccs = pt_sccs, area_scc = scc) 
pt_subs <- project_baseline(base_table = pt_subs, projection_table = projection_tables[["ManEmp"]], has_pt = TRUE)
temp_table_final <- subtract_pt_sources(base_emission_table = temp_table_controlled, pt_source_table = pt_subs)

# add to final table
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, temp_table, ww_ef, temp_table_project, temp_table_controlled, pt_sccs, pt_subs, temp_table_final)


# Solvent Utilization > Miscellaneous Non-industrial: Commercial > Cutback Asphalt > Total: All Processes
## We use UDOT data for this scc; calculate throughput by multiplying % of VMT traveled in each county relative to the entire state by the sum of throughput from WW (which is tons emulsified asphalt used in the state), then multiply by EFs from WW, project based on population growth, no controls, no pt source subtractions.
scc <- 2461021000

### Note: The NEMO includes an EF for hydrogen sulfide, but the WW does not include hydrogen sulfide.

# Throughput is % of total vehicle miles traveled daily (VMT) from UDOT in each county relative to the state total, multiplied by the tons of state-level asphalt usage in the entire state from EPA.
## EPA uses FHWA data for VMT in the whole state, then allocates to counties based on MOVES data; more accurate to use VMT for counties directly from UDOT.
## Note in the old input excel table: "Previously included MPO data for certain counties and years but Mobile Source's Rick McKeague suggested that it is better to use UDOT data as MPOs often 'winterize' their daily VMTs."
## I think that this is referring to UDOT data being better than MOVES data, which would provide a justification for using our own VMT data from UDOT to calculate tons emissions in each county instead of the EPA data from WW.

# Pull tons cutback asphalt usage in Utah from WW (this is the sum of the throughputs)
# throughput is the same for all of the pollutants, so I'm just going to only filter for VOC and then sum throughput.
# this is the total tons of cutback asphalt usage in the entire state (EPA gets this from a 2008 report, and then adjusts to the baseline year)
throughput <-
  ww %>% filter(SourceClassificationCode == scc, PollutantCode == 'VOC') %>%
  select(Throughput) %>% sum()

# Now to get the tons/county in each Utah county, I need to multiply the statewide total tons by the % of total VMTs traveled in the county as compared to the entire state total VMTs.
# So we got the statewide number of tons of cutback asphalt used above, and instead of using MOVES data (what EPA uses to estimate cutback asphalt usage in each county), we're going to use vehicle-miles traveled, available from UDOT.
# In the NEMO, it appears that EPA uses state-level VMT data from the FHWA and then estimates county-level VMT data by apportioning based on MOVES data, but UDOT provides the state-level VMT data to FHWA by summing over all of the county VMT data in the state, so using the original county VMT data is more accurate than attempting to re-allocate it to counties based on MOVES data

# read in the VMT table from the References folder
vmt <- projection_tables[["VMT"]] %>% filter(year == start_year)

# add a column that identifies the percent of the VMT in each county relative to the sum of all counties
vmt$VMT_pct <- vmt$unit/sum(vmt$unit)

# now we need to multiply that VMT_pct column by the total throughput for Utah (tons asphalt used) calculated above
vmt$Throughput <- vmt$VMT_pct * throughput

# then multiply that by the EF for each of the pollutants
## first get the EFs
efs_table <- pull_efs_from_ww(scc = scc, throughput_unit = 'TON', all_primaries = TRUE)

## merge the efs_table and vmt
temp_table <- merge(efs_table, vmt, by = "county")

## add a column for TPY
temp_table$TPY <- temp_table$TPUPY * temp_table$Throughput

# now match formatting of the final_table
## with FIPS, SCC, year, pollutant, and TPY columns
temp_table <- temp_table %>%
  select(county, SCC, year, pollutant, TPY) %>%
  rename(FIPS = county)

# project by population growth
# Note: the workbook notes that projections are based on a regression by Peter Verschoor, but really they are just projecting based on population growth.
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["Population"]])

# No controls
# No pt source subtractions

temp_table_final <- temp_table_project
# add to final table
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc, except vmt because we use it below
rm(scc, throughput, efs_table, temp_table, temp_table_project, temp_table_final)


# Solvent Utilization > Miscellaneous Non-industrial: Commercial > Emulsified Asphalt > Total: All Processes
# Use UDOT data for VMT in each county; to get throughput, multiply % of VMT in each county relative to total VMT across the state by the sum of all throughput from WW (which is the total tons of emulsified asphalt used in the state), multiply by the EFs from the WW, project based on population growth, and add to the final table
scc <- 2461022000

### Note: the NEMO includes the EF for Hydrogen Sulfide, but the WW does not include an estimate for it.
# Throughput is % of total vehicle miles traveled daily (VMT) from UDOT in each county relative to the state total, multiplied by the tons of state-level asphalt usage in the entire state from EPA.

# Pull total throughput in Utah from WW
# throughput is the same for all of the pollutants, so I'm just going to only filter for VOC and then sum throughput.
# this is the total tons of emulsified asphalt usage in the entire state (EPA gets this from a 2008 report, and then adjusts to the baseline year)
throughput <-
  ww %>% filter(SourceClassificationCode == scc, PollutantCode == 'VOC') %>% select(Throughput) %>% sum()

# Now to get the tons/county in each Utah county, I need to multiply the statewide total tons for emulsified asphalt (the sum of throughput above) by the % of total VMTs traveled in the county as compared to the entire state total VMTs.
# So we got the statewide number of tons of emulsified asphalt used above, and instead of using MOVES data (what EPA uses to estimate emulsified asphalt usage in each county), we're going to use vehicle-miles traveled, available from UDOT.
# In the NEMO, it appears that EPA uses state-level VMT data from the FHWA and then estimates county-level VMT data by apportioning based on MOVES data, but UDOT provides the state-level VMT data to FHWA by summing over all of the county VMT data in the state, so using the original county VMT data is more accurate than attempting to re-allocate it to counties based on MOVES data

# overwrite the VMT_pct column by the total throughput for Utah (tons asphalt used) calculated above
vmt$Throughput <- vmt$VMT_pct * throughput

# then multiply that by the EF for each of the pollutants
# first get the EFs
efs_table <- pull_efs_from_ww(scc = scc, throughput_unit = 'TON', all_primaries = TRUE)

# merge the efs_table and vmt
temp_table <- merge(efs_table, vmt, by = "county")

# add a column for TPY
temp_table$TPY <- temp_table$TPUPY * temp_table$Throughput

# now match formatting of the final_table
## with FIPS, SCC, year, pollutant, and TPY columns
temp_table <- temp_table %>%
  select(county, SCC, year, pollutant, TPY) %>%
  rename(FIPS = county)

# project by population growth
# Note: the workbook notes that projections are based on a regression by Peter Verschoor, but really they are just projecting based on population growth.
temp_table_project <- project_baseline(base_table = temp_table, projection_table = projection_tables[["Population"]])

# No controls
# No pt source subtractions

temp_table_final <- temp_table_project
# add to final table
final_table <- rbind(final_table, temp_table_final)
# remove the objects we created for this scc
rm(scc, throughput, efs_table, temp_table, vmt, temp_table_project, temp_table_final)
```

## Storage and Transport

```{r}
# Storage & Transport > Petroleum and Petroleum Product Storage > Residential Portable Gas Cans > Permeation
scc <- 2501011011

# Storage and Transport > Petroleum and Petroleum Product Storage > Residential Portable Gas Cans > Evaporation (includes Diurnal losses)
scc <- 2501011012

# Storage and Transport > Petroleum and Petroleum Product Storage > Residential Portable Gas Cans > Spillage During Transport
scc <- 2501011013

# Storage and Transport > Petroleum and Petroleum Product Storage > Residential Portable Gas Cans > Refilling at the Pump - Vapor Displacement
scc <- 2501011014

# Storage and Transport > Petroleum and Petroleum Product Storage > Residential Portable Gas Cans > Refilling at the Pump - Spillage
scc <- 2501011015

# Storage and Transport > Petroleum and Petroleum Product Storage > Commercial Portable Gas Cans > Permeation
scc <- 2501012011

# Storage and Transport > Petroleum and Petroleum Product Storage > Commercial Portable Gas Cans > Evaporation (includes Diurnal losses)
scc <- 2501012012

# Storage and Transport > Petroleum and Petroleum Product Storage > Commercial Portable Gas Cans > Spillage During Transport
scc <- 2501012013

# Storage and Transport > Petroleum and Petroleum Product Storage > Commercial Portable Gas Cans > Refilling at the Pump - Vapor Displacement
scc <- 2501012014

# Storage and Transport > Petroleum and Petroleum Product Storage > Commercial Portable Gas Cans > Refilling at the Pump - Spillage
scc <- 2501012015
```





```{r 3.2) pull EFs from WW}

#FIFRA products, solvents. (Federal Insecticide, Fungicide, and Rodenticide Act)
#1) Emission Factors and calculation methods from EPA/NOMAD (for the 2014 NEI). Note: Activity data was based on USGS report “Estimated Annual Agricultural Pesticide Use for Counties of the Conterminous United States, 2008-2012”.												
#2) based on population
#2) projects based on agJobs
scc <- 2460800000
efs_table <- pull_efs_from_ww(scc, throughput_unit = 'EACH',all_primaries = FALSE)
temp_table <- make_baseline(efs_table,projection_tables[["Population"]])
temp_table <- project_baseline(temp_table , projection_tables[["AgJobs"]])
#no pt subtract
#no controls
final_table <- rbind(final_table, temp_table)

#solvent, personal care
#based on EPA NOMAD method
#baseline and projection on population
#1) Control percent phase in provided by Utah DAQ's Joel Karmazyn based on existing rules. Phase in was conservatively calculated to begin in 2014.						
scc <- 2460100000
efs_table <- pull_efs_from_ww(scc,throughput_unit = 'EACH',all_primaries = FALSE)
temp_table <- make_baseline(efs_table,projection_tables[["Population"]],project_to = end_year)
#no pt sources
# rule R307-357, https://rules.utah.gov/publicat/code/r307/r307-357.htm
# "assume first product hit shelf in 2016"
# it is not clear from rule 357 what the control efficiency is, you have to
# look at our 2017 TSD. This applies for all 357-controlled SCCs
temp_table <- add_controls(temp_table,scc,naa_counties,2015,2016,0.916)
final_table <- rbind(final_table, temp_table)

#solvent, household products
#based on EPA NOMAD method
#baseline and projection on population
#1) Control percent phase in provided by Utah DAQ's Joel Karmazyn based on existing rules. Phase in was conservatively calculated to begin in 2014.						
scc <- 2460200000
efs_table <- pull_efs_from_ww(scc,throughput_unit = 'EACH',all_primaries = FALSE)
temp_table <- make_baseline(efs_table,projection_tables[["Population"]],project_to = end_year)
#no pt sources
# rule R307-357, https://rules.utah.gov/publicat/code/r307/r307-357.htm
# see 2460100000
temp_table <- add_controls(temp_table,scc,naa_counties,2015,2016,0.755)
final_table <- rbind(final_table, temp_table)

#solvent, auto aftermarket products
#based on EPA NOMAD method
#baseline and projection on population
#1) Control percent phase in provided by Utah DAQ's Joel Karmazyn based on existing rules. Phase in was conservatively calculated to begin in 2014.						
scc <- 2460400000
efs_table <- pull_efs_from_ww(scc, throughput_unit = 'EACH', all_primaries = FALSE)
temp_table <- make_baseline(efs_table,projection_tables[["Population"]],project_to = end_year)
#no pt sources?
# rule R307-357, https://rules.utah.gov/publicat/code/r307/r307-357.htm
# see 2460100000
temp_table <- add_controls(temp_table,scc,naa_counties,2015,2016,0.936)
final_table <- rbind(final_table, temp_table)

#solvent, coatings & related products
#based on EPA NOMAD method
#baseline and projection on population
#1) Control percent phase in provided by Utah DAQ's Joel Karmazyn based on existing rules. Phase in was conservatively calculated to begin in 2014.						
scc <- 2460500000
efs_table <- pull_efs_from_ww(scc, throughput_unit = 'EACH', all_primaries = FALSE)
temp_table <- make_baseline(efs_table,projection_tables[["Population"]],project_to = end_year)
#no pt sources?
# rule R307-357, https://rules.utah.gov/publicat/code/r307/r307-357.htm
# see 2460100000
temp_table <- add_controls(temp_table,scc,naa_counties,2015,2016,0.913)
final_table <- rbind(final_table, temp_table)

#solvents, adhesives and sealants
#based on EPA NOMAD method
#baseline and projection on population
#1) Control percent phase in provided by Utah DAQ's Joel Karmazyn based on existing rules. Phase in was conservatively calculated to begin in 2014.						
scc <- 2460600000
efs_table <- pull_efs_from_ww(scc, throughput_unit = 'EACH', all_primaries = FALSE)
temp_table <- make_baseline(efs_table,projection_tables[["Population"]],project_to = end_year)
#no pt sources
# rule R307-357, https://rules.utah.gov/publicat/code/r307/r307-357.htm
# see 2460100000
temp_table <- add_controls(temp_table,scc,naa_counties,2013,2018,0.49)
final_table <- rbind(final_table, temp_table)

#solvents, consumer use, miscellaneous 
#based on EPA NOMAD method
#baseline and projection on population
scc <- 2460900000
efs_table <- pull_efs_from_ww(scc, throughput_unit = 'EACH', all_primaries = FALSE)
temp_table <- make_baseline(efs_table,projection_tables[["Population"]],project_to = end_year)
#no pt subtract
#no controls
final_table <- rbind(final_table, temp_table)

#ICI construction dust.
#based on dollars spent on non-residential construction by county. $ used is
#used convert to assume acres disturbed/year.
#If you look in NOMAD, you will find a term: 'PE' that informs EFs. It has to do 
#with rain, and I think can be targeted in the WW tool. It currently is one value 
#for the whole state, but could be adjusted for county-by-county.
#
#projects with population
scc <- 2311020000
#NonresidentialConstruction is dollars spent on non-residential construction per county
#now get acres by assuming 1.00885 acres/million dollars spent
#then get acre-month by assuming 11 months of construction per project
#  both of these conversion factors (1.00885, 11) are from NOMAD, and 
#  could potentially be out of date.
input_table <- projection_tables[["NonresidentialConstruction"]] %>% 
  #filter for year and adjust units
  filter(year==start_year) %>% mutate(unit = unit*1.00885/1E6*11)
#pull efs from ww
efs_table <- pull_efs_from_ww(scc,throughput_unit = 'ACRE-MONTH', all_primaries = TRUE)
temp_table <- make_baseline(efs_table, input_table)
temp_table <- project_baseline(temp_table,projection_tables[["Population"]])
#project
#Controls: R307-309 is about fugitive dust control plans. Has an assumed 32% 
#reduction that started in 2014.
temp_table <- add_controls(temp_table)
final_table <- rbind(final_table,temp_table)


#surface coatings, architectural
#pulled from WW
#based on population
#projects with population
scc <- 2401001000
efs_table <- pull_efs_from_ww(scc,'EACH',all_primaries = FALSE)
temp_table <- make_baseline(efs_table, projection_tables[["Population"]], project_to = end_year)
#controls are based on R307-361: "architectural coatings"
temp_table <- add_controls(temp_table)
#pt subs? Maybe used to be but is no longer supported in EPA crosswalk.
final_table <- rbind(final_table,temp_table)
```



```{r 3.3) pull baseline emissions from WW, but manually project}

#non-industrial commercial pesticides
#1) Emission Factors and calculation methods from EPA/NOMAD (for the 2014 NEI). Note: Activity data was based on USGS report “Estimated Annual Agricultural Pesticide Use for Counties of the Conterminous United States, 2008-2012”.												
#2) based on WW (agjobs p sure)
#3) projects based on agjobs
scc <- 2461850000
temp_table <- pull_baseline_from_ww(scc) 
temp_table <- project_baseline(temp_table, projection_tables[["AgJobs"]])
#no pt subtraction
#no controls
final_table <- rbind(final_table, temp_table)

#Open burning land clearing
#pulled from WW.
#scales with population
#Emissions for this SCC are read, but then set to zero as this type of burning is not typically practiced in Utah and no burning of cleared debris (slash) from a  construction project was permitted in 2014 per State Fire Marshall Coy Porter. Therefore, activity data was set at zero tons of debris burned for all counties.	
# EPA estimates emissions from this SCC on the order of 12,000 TPY of CO, so zeroing it is kind of a big deal. Do we have any methods to track illegal burning?
scc <- 2610000500
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,projection_tables[["Population"]])
counties <- seq.int(49001,49057,2)
#here is where we turn everything into zeros
temp_table <- add_manual_controls(temp_table,scc,counties,1900,1901,0)
final_table <- rbind(final_table, temp_table)

#unpaved roads emissions
#baseline from WW
#projection based on AgJobs
#  projection is based on agjobs because agricultural operations are anticipated to represent a large portion of unpaved road use. Agriculture is also a better projection than population growth as typically population growth results in development of agricultural lands and paving of previously unpaved roads (population growth would be more likely to be inversely related to unpaved road dust emissions). While agricultural employment will not account for recreational use of unpaved roads, this was considered moot as population increases may increase recreational uses however that same population growth also reduces the amount of unpaved roads.
#Emission factors vary based on the unpaved road type and precipitation correction and can be tweaked in WW - this might be worth looking into
#This SCC is huge
scc <- 2296000000
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,projection_tables[["AgJobs"]])
#no controls
#there is probably some pt source subtraction I could do here, but none for now
#prioritize pt subs for this because this is a large scc
final_table <- rbind(final_table, temp_table)

#industrial processes,
#food and kindred products, SIC 20
#commercial cooking - charbroiling
#conveyorized charbroiling
#
#NOMAD method is based on number of restaurants in each county, number of cooking
#  devices in each restaurant, amount of meat processed on each device. elaborate.
#projects with population
scc <- 2302002100 
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,projection_tables[["Population"]])
#add controls
#Controls began in 2016 and are provided by Utah DAQ's Joel Karmazyn based on existing rules.
#Rule 370-303 has a 76% reduction in emissions for VOC and PM25. For This 
#  specific SCC, PM25 ~= PM10, so I will be controlling it with the same factor.
#  that is an approximation though.
#The workbook only controlled VOC/HAPS, but I added PM because the rule language
#  suggests PM is being controlled.
#for this SCC, the only pollutant we do not target is CO
target_pollutants <- sort(unique(temp_table$pollutant))
target_pollutants <- target_pollutants[!target_pollutants %in% 'CO']
temp_table <- add_controls(temp_table,scc,naa_counties,2015,2016,0.24,pollutants = target_pollutants )
#no pt subs?
final_table <- rbind(final_table, temp_table)

#industrial processes,
#food and kindred products, SIC 20
#commercial cooking - charbroiling
#under-fired charbroiling
#
#NOMAD method is based on number of restaurants in each county, number of cooking
#  devices in each restaurant, amount of meat processed on each device. elaborate.
#projects with population
scc <- 2302002200 
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,projection_tables[["Population"]])
#no controls?
#no pt subs?
final_table <- rbind(final_table, temp_table)

#industrial processes,
#food and kindred products, SIC 20
#commercial cooking - frying
#deep fat frying
#
#NOMAD method is based on number of restaurants in each county, number of cooking
#  devices in each restaurant, amount of meat processed on each device. elaborate.
#projects with population
scc <- 2302003000
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,projection_tables[["Population"]])
#no controls?
#no pt subs?
final_table <- rbind(final_table, temp_table)

#industrial processes,
#food and kindred products, SIC 20
#commercial cooking - frying
#flat griddle frying
#
#NOMAD method is based on number of restaurants in each county, number of cooking
#  devices in each restaurant, amount of meat processed on each device. elaborate.
#projects with population
scc <- 2302003100
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,projection_tables[["Population"]])
#no controls?
#no pt subs?
final_table <- rbind(final_table, temp_table)

#industrial processes,
#food and kindred products, SIC 20
#commercial cooking - frying
#clamshell griddle frying
#
#NOMAD method is based on number of restaurants in each county, number of cooking
#  devices in each restaurant, amount of meat processed on each device. elaborate.
#projects with population
scc <- 2302003200
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,projection_tables[["Population"]])
#no controls
#no pt subs?
final_table <- rbind(final_table, temp_table)

#tilling of agriculture crops
#NOMAD looks at number of acres tilled in each county by crop type and tilling type. Looks at silt content etc.
#projects with Agricultural employment
scc <-2801000003
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,projection_tables[["AgJobs"]])
#no pt subs
#no controls
final_table <- rbind(final_table, temp_table)

#residential grilling (see 2302002XXX for commercial)
#taken from WW
#scales with population
scc <- 2810025000
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,projection_tables[["Population"]])
#no pt subs
#no controls
final_table <- rbind(final_table, temp_table)

#human cremation
#morbid. 
#WW takes deaths in each county and cremation rate, then uses
#average weight of a person for each age range of people that died.
#that gets Mass of dead bodies, and it multiplies that by EFs for burning bodies.
#morbid.
#scales with population, haha.
scc <- 2810060100
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,projection_tables[["Population"]])
#no pt subs
#no controls
final_table <- rbind(final_table, temp_table)

#pet cremation. 
#also morbid
#scales with population
scc <- 2810060200
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,projection_tables[["Population"]])
#no pt subs
#no controls
final_table <- rbind(final_table, temp_table)

#open burning of Residential Household Waste (RHW)
#NEMO takes a waste/person value, and then assumes that 24% of the rural 
#  population burns a portion of their waste.
#projects with population
scc <- 2610030000
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table, projection_tables[["Population"]])
#Rule R307-202 bans this kind of open burning. We assume 80% compliance with the rule
#  except for Salt Lake, which we assume 100% compliance.
#from our rule website, it looks like the rule was implemented late 2014. 
#  (It's not in the normal control TSD). I'll assume 2015 was fully implemented.
counties <- seq.int(49001,49057,2)
temp_table  <- add_controls(temp_table,scc,counties,st_year = 2014,e_year = 2015,0.2)
#then do extra control for SLC
temp_table  <- add_controls(temp_table,scc,49035,st_year = 2014,e_year = 2015,0.0)
#no pt subs. This is like, burning residential stuff. Not in permits
final_table <- rbind(final_table,temp_table)

#open burning - all categories
#yard waste - leaf species unspecified
#
#NOMAD gets a waste/person number, and then assumes rural folks burn 28% of waste.
#  this requires a live update of the portion of rural population per county, which
#  WW maintains
#The burning of yard clippings is illegal in Utah during certain times of the year.
#If you want seasonal activity, look at EPA's Emissions Inventory Improvement Plan Table 1.4-3.
scc <- 2610000100
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,projection_tables[["Population"]])
#controls:
#there are 17 counties (16 + SLC) that participate in the DAQ open burning permit program (established in 
#  Utah Administrative Code  R307-202) and were, therefore, allocated a control 
#  with 80% reduction per AirControlNet, Document No. 06.05.003/9011.002, 
#  page III-405. (https://www.epa.gov/ground-level-ozone-pollution). 
#    (I can not find this document)
#  assume participating counties have a 80% control.
#  Rule 202 was implemented late 2014 I believe, so assume fully phased in by 2015.
#NOTE: the number of participating counties could have changed since this was updated.
counties <- c(49001,49003,49005,49007,
              49011,49013,49015,49021,
              49023,49043,49045,49047,
              49049,49053,49055,49057)
temp_table  <- add_controls(temp_table,scc,counties,st_year = 2014,e_year = 2015,0.2)
#  Salt Lake County's control was raised to 100% due to their ordinance 9.24.140 
#  and 9.24.150 banning open burning 
temp_table  <- add_controls(temp_table,scc,49035,st_year = 2014,e_year = 2015,0.0)
#no pt subs
final_table <- rbind(final_table,temp_table)

#open burning - all categories
#yard waste - brush species unspecified
#
#NOMAD gets a waste/person number, and then assumes rural folks burn 28% of waste
#  this requires a live update of the portion of rural population per county.
#The burning of yard clippings is illegal in Utah during certain times of the year.
#If you want seasonal activity, look at EPA's Emissions Inventory Improvement Plan Table 1.4-3.
scc <- 2610000400
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table,projection_tables[["Population"]])
#controls:
#there are 17 counties (16 + SLC) that participate in the DAQ open burning permit program (established in 
#  Utah Administrative Code  R307-202) and were, therefore, allocated a control 
#  with 80% reduction per AirControlNet, Document No. 06.05.003/9011.002, 
#  page III-405. (https://www.epa.gov/ground-level-ozone-pollution). 
#    (I can not find this document)
#  assume participating counties have a 80% control.
#  Rule 202 was implemented late 2014 I believe, so assume fully phased in by 2015.
#NOTE: the number of participating counties could have changed since this was updated.
counties <- c(49001,49003,49005,49007,
              49011,49013,49015,49021,
              49023,49043,49045,49047,
              49049,49053,49055,49057)
temp_table  <- add_controls(temp_table,scc,counties,st_year = 2014,e_year = 2015,0.2)
#  Salt Lake County's control was raised to 100% due to their ordinance 9.24.140 
#  and 9.24.150 banning open burning 
temp_table  <- add_controls(temp_table,scc,49035,st_year = 2014,e_year = 2015,0.0)
#no pt subs
final_table <- rbind(final_table,temp_table)


#storage and transport of petroleum and petroleum products
#bulk plants, all evaporative losses - gasoline
#
#EPA has noted that there is a potential for overlap with point sources for 
#SCCs: 2501055120 (likely with Bulk Terminals) and 2505040120

scc <- 2501055120
temp_table <- pull_baseline_from_ww(scc)

#EPA has noted that there is a potential for overlap with point sources for 
#SCCs: 2501055120 (likely with Bulk Terminals) and 2505040120
scc <- 2505040120
test <- pull_baseline_from_ww(scc)

```

I put wood burning stuff in its own section - it has some complex control methods.
THIS NEEDS TO SCALE WITH RESIDENTIAL WOOD FROM 'WOODBTU'. THE OLD WOOD TABLE IS NOT NEEDED.
```{r wood burning WW pulls. See 2104008XXX_woodstoves.xlsx in main_workbook folder for further notes}



#Controls for "red" burn days/no burn days are NOT applied here. Modeling has to do that. We don't apply them
#here because it requires Tons per day resolution on data, and this inventory only gives TPY.

#According to Utah Administrative Code R307-208, "Outdoor wood boiler" means a fuel burning device also known as a wood-fired hydronic heater. New outdoor wood boiler commences operation on or after March 1, 2013. From the public meeting in 2013,  there was 1 person from Box Elder and 1 from Wasatch in all meetings and the rest of 50 were divided between Salt lake and Utah counties have central heating boilers. The hydronic heater is expensive and forbidden to sell in the nonattainment area. We assumed no hydronic heaters for the rest of the State. Reported by Joel Karmazyn from Utah Division of Air Quality 801-536-4423 on July 23, 2019.										

#I added these controls 9/10/2020 to account for our success in replacing wood stoves with NG heating. Practically speaking, each stove replaced should be reflected with a lower tonnage of wood burned, but we were only reading the WW output, so the reduction was reached indirectly by using a pseudo-control on certain counties.
#Each stove replaced translates to a lower wood burned throughput, which leads to lower emissions. I added a control to each SCC/County that would reduce emissions an equal amount to this lower wood throughput. This control scales with the SCC growth, which I am comfortable assuming, as our woodstove replacement program is ongoing.

#See '2104008XXX_woodstoves.xlsx' in main_workbook folder for further notes

#All of the stoves removed and TPY's reduced were spread out over the Salt Lake NAA. The reduction quantities were distributed as follows:
#Box Elder County 5.4%
#Davis County 25.1%
#Salt Lake County 57.6%
#Tooele County 1.3%
#Weber County 10.6%

#assume wood density of 1.04 Tons/Cord
#most up-to-date emission factors are in the WW tool. I used WW EFs to figure out the TPY reduction.
#352 of all of the units were replaced in 2018, so I assumed a complete phase-in finished for 2018. This is a rough approximation, but is accurate enough.
#wood fireplace, general
#685 units removed at 0.08234 cords/unit/year
#PM25-PRI reduced 0.6906 TPY
scc <- 2104008100
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table, projection_tables[["WoodBTU_Residential"]])
temp_table <- add_controls( temp_table, scc,counties = 49003, st_year = 2017, e_year = 2018,end_val = 0.98326)
temp_table <- add_controls( temp_table, scc,counties = 49011, st_year = 2017, e_year = 2018,end_val = 0.98450)
temp_table <- add_controls( temp_table, scc,counties = 49035, st_year = 2017, e_year = 2018,end_val = 0.98781)
temp_table <- add_controls( temp_table, scc,counties = 49045, st_year = 2017, e_year = 2018,end_val = 0.99653)
temp_table <- add_controls( temp_table, scc,counties = 49057, st_year = 2017, e_year = 2018,end_val = 0.99264)
final_table <- rbind(final_table,temp_table)

#Woodstove, fireplace insert, non-EPA certified
# 70 units at 0.1135 cords/unit/year
# PM25-PRI reduced 0.1261
scc <- 2104008210
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table, projection_tables[["WoodBTU_Residential"]])
temp_table <- add_controls( temp_table, scc,counties = 49003, st_year = 2017, e_year = 2018,end_val = 0.97621)
temp_table <- add_controls( temp_table, scc,counties = 49011, st_year = 2017, e_year = 2018,end_val = 0.98321)
temp_table <- add_controls( temp_table, scc,counties = 49035, st_year = 2017, e_year = 2018,end_val = 0.98817)
temp_table <- add_controls( temp_table, scc,counties = 49045, st_year = 2017, e_year = 2018,end_val = 0.99498)
temp_table <- add_controls( temp_table, scc,counties = 49057, st_year = 2017, e_year = 2018,end_val = 0.99140)
final_table <- rbind(final_table,temp_table)

#woodstove, fireplace insert, EPA certified non-catalytic
#no controls
scc <- 2104008220
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table, projection_tables[["WoodBTU_Residential"]])
final_table <- rbind(final_table,temp_table)

#woodstove, fireplace insert, EPA certified, catalytic
#no controls
scc <- 2104008230
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table, projection_tables[["WoodBTU_Residential"]])
final_table <- rbind(final_table,temp_table)

#woodstove, freestanding, non-EPA certified
#117 units at 0.2825 cords/unit/year
#PM25-PRI reduced 0.5248 TPY
scc <- 2104008310
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table, projection_tables[["WoodBTU_Residential"]])
temp_table <- add_controls( temp_table, scc,counties = 49003, st_year = 2017, e_year = 2018,end_val = 0.98542)
temp_table <- add_controls( temp_table, scc,counties = 49011, st_year = 2017, e_year = 2018,end_val = 0.98229)
temp_table <- add_controls( temp_table, scc,counties = 49035, st_year = 2017, e_year = 2018,end_val = 0.98526)
temp_table <- add_controls( temp_table, scc,counties = 49045, st_year = 2017, e_year = 2018,end_val = 0.99653)
temp_table <- add_controls( temp_table, scc,counties = 49057, st_year = 2017, e_year = 2018,end_val = 0.99390)
final_table <- rbind(final_table,temp_table)

#woodstove, freestanding, EPA certified, non-catalytic
#2 units at 0.2825 cords/unit/year
#PM25-PRI reduced 0.002568 TPY
scc <- 2104008320
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table, projection_tables[["WoodBTU_Residential"]])
temp_table <- add_controls( temp_table, scc,counties = 49003, st_year = 2017, e_year = 2018,end_val = 0.99981)
temp_table <- add_controls( temp_table, scc,counties = 49011, st_year = 2017, e_year = 2018,end_val = 0.99977)
temp_table <- add_controls( temp_table, scc,counties = 49035, st_year = 2017, e_year = 2018,end_val = 0.99981)
temp_table <- add_controls( temp_table, scc,counties = 49045, st_year = 2017, e_year = 2018,end_val = 0.99996)
temp_table <- add_controls( temp_table, scc,counties = 49057, st_year = 2017, e_year = 2018,end_val = 0.99992)
final_table <- rbind(final_table,temp_table)

#woodstove, freestanding, EPA certified, catalytic
#no controls
scc <- 2104008330
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table, projection_tables[["WoodBTU_Residential"]])
final_table <- rbind(final_table,temp_table)

#woodstove, pellet-fired, general (freestanding or FP insert)
#11 units at 0.1223 cords/unit/year
#PM25-PRI reduced 0.002135 TPY
scc <- 2104008400
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table, projection_tables[["WoodBTU_Residential"]])
temp_table <- add_controls( temp_table, scc,counties = 49003, st_year = 2017, e_year = 2018,end_val = 0.99817)
temp_table <- add_controls( temp_table, scc,counties = 49011, st_year = 2017, e_year = 2018,end_val = 0.99892)
temp_table <- add_controls( temp_table, scc,counties = 49035, st_year = 2017, e_year = 2018,end_val = 0.99939)
temp_table <- add_controls( temp_table, scc,counties = 49045, st_year = 2017, e_year = 2018,end_val = 0.99954)
temp_table <- add_controls( temp_table, scc,counties = 49057, st_year = 2017, e_year = 2018,end_val = 0.99958)
final_table <- rbind(final_table,temp_table)

#furnace, indoor, cordwood-fired, non-EPA certified
#no controls
scc <- 2104008510
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table, projection_tables[["WoodBTU_Residential"]])
final_table <- rbind(final_table,temp_table)

#hydronic heater, outdoor
#I don't understand the initial comment on this SCC about hydronic heaters, but this SCC is tiny.
#no controls
scc <- 2104008610
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table, projection_tables[["WoodBTU_Residential"]])
final_table <- rbind(final_table,temp_table)

#outdoor wood burning device, NEC (fire-pits, chimeas, etc)
#I think this one is like OG fires? Like for camping? And also Chimeas lol
#no controls
scc <- 2104008700
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table, projection_tables[["WoodBTU_Residential"]])
final_table <- rbind(final_table,temp_table)

#firelog, total: all combustor types
#no controls
scc <- 2104009000
temp_table <- pull_baseline_from_ww(scc)
temp_table <- project_baseline(temp_table, projection_tables[["WoodBTU_Residential"]])
final_table <- rbind(final_table,temp_table)

```


need to add these SCCs
```{r} 
describe(scc)
          
#stationary fuel combustion
#residential distillate oil - all types
#do later
scc <- 2104004000
temp_table <- pull_baseline_from_ww(scc)



```

```{r old sccs that I had to adjust HAPS for comparisons}
raw_sccs_from_ww <- consolidate_xylenes(raw_sccs_from_ww, c(2104008210, 2104008230, 2104008310, 2104008330, 2810025000))

```
  5) Merge inventories.
    Now that we have updated all of the SCCs that we can (for now), let's merge our new data into the most up-to-date complete inventory table.
    5.1) Identify every SCC in our new table
    5.2) remove those SCCs from the old inventory table. Keep all the old inventory sccs that weren't modified with this script.
    5.3) Merge together the old, unmodified SCCs with the new SCCs. 
    5.3X) OPTIONAL: Consolidate PM by removing PM10-FIL, PM-CON, PM25-FIL, and changing the names of PM10-PRI/PM25-PRI to PM10/PM25.
    5.3Y) OPTIONAL: Consolidate Xylenes by removing O, P, and M-Xylenes and grouping them all as Xylenes-Total.
    5.4) Save that final table
    
```{r merge inventories}
advanced_sccs <- sort(unique(final_table$SCC))
old_model_filtered_sccs <- old_model_data %>% filter(! SCC %in% advanced_sccs)

final_table <- rbind(old_model_filtered_sccs,final_table)




```


